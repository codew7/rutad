<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema RUTA D</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #3a3b3f;
            --primary-dark: #2b2c2e;
            --secondary-color: #64748b;
            --success-color: #059669;
            --warning-color: #d97706;
            --error-color: #dc2626;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            left: 0;
            top: 0;
            width: 280px;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--primary-color);
            color: white;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            font-size: 1.25rem;
        }

        .nav-menu {
            padding: 1rem 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary-color);
            color: white;
        }

        .nav-item i {
            width: 1.25rem;
            text-align: center;
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }

        .menu-toggle:hover {
            background: var(--bg-color);
        }

        .breadcrumb {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .content-area {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-input {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            background: var(--card-bg);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgb(37 99 235 / 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
        }

        .btn-purple {
            background: #8e44ad;
            color: white;
        }

        .btn-purple:hover {
            background: #7d3c98;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
        }

        .table th {
            background: var(--bg-color);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .table tr:hover {
            background: var(--bg-color);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-lg);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            color: white;
        }

        .stat-icon.primary { background: var(--primary-color); }
        .stat-icon.success { background: var(--success-color); }
        .stat-icon.warning { background: var(--warning-color); }
        .stat-icon.danger { background: var(--error-color); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                box-shadow: none;
            }
            .sidebar.show {
                transform: translateX(0);
                box-shadow: 0 0 0 100vw rgba(0,0,0,0.3);
            }
            .main-content {
                margin-left: 0;
            }
            .content-area {
                padding: 1rem;
            }
            .sidebar-overlay {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,0.3);
                z-index: 999;
            }
            .sidebar.collapsed {
                transform: translateX(-100%);
            }
    /* Fin del bloque @media */
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Loading */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid currentColor;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 3000;
        }

        .toast {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            padding: 1rem;
            margin-bottom: 0.5rem;
            min-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success { border-left: 4px solid var(--success-color); }
        .toast.error { border-left: 4px solid var(--error-color); }
        .toast.warning { border-left: 4px solid var(--warning-color); }

        /* View Modal Styles */
        .view-details {
            line-height: 1.6;
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .view-header h4 {
            margin: 0;
            color: var(--primary-color);
        }

        .view-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--background-secondary);
            border-radius: 8px;
        }

        .view-section h5 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .view-section p {
            margin: 0.5rem 0;
            color: var(--text-secondary);
        }

        .view-section strong {
            color: var(--text-primary);
        }

        .total-section {
            text-align: right;
            padding: 1rem;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .total-section h4 {
            margin: 0;
            font-size: 1.25rem;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .badge-success {
            background-color: var(--success-color);
            color: white;
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .badge-danger {
            background-color: var(--error-color);
            color: white;
        }

        /* Estilos para Venta de Insumos */
        .form-section {
            margin: 1.5rem 0;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: var(--bg-color);
        }

        .totals-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }

        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .total-item {
            padding: 0.5rem;
            text-align: center;
            background: var(--bg-color);
            border-radius: 0.25rem;
        }

        .venta-insumo-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 0.5rem;
            align-items: end;
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }

        .venta-insumo-item .form-group {
            margin-bottom: 0;
        }

        .item-remove-btn {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            height: 2.5rem;
            width: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-remove-btn:hover {
            background: #b91c1c;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <img src="Logo.png" alt="Logo RUTA D" class="login-logo">
                    <h1>Sistema RUTA D</h1>
                    <p>Inicia sesión para acceder al sistema</p>
                </div>
                
                <form id="loginForm" class="login-form">
                    <div class="form-group">
                        <label for="loginEmail" class="form-label">Correo electrónico</label>
                        <input type="email" id="loginEmail" class="form-input" placeholder="Ingresa tu correo" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword" class="form-label">Contraseña</label>
                        <input type="password" id="loginPassword" class="form-input" placeholder="Ingresa tu contraseña" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-full" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i>
                        Iniciar Sesión
                    </button>
                    
                    <div id="loginError" class="login-error" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>
    <div class="app-container">
        <!-- Sidebar -->
    <div class="sidebar-overlay hidden" id="sidebarOverlay"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-wrench"></i>
                    <span>Taller RUTA D</span>
                </div>
            </div>
            <div style="position: absolute; bottom: 2rem; left: 0; width: 100%; display: flex; justify-content: center; align-items: center;">
                <img src="Logo.png" alt="Logo" style="max-width: 250px; max-height: 250px; display: block; margin: 0 auto;">
            </div>
            
            <nav class="nav-menu">
                <button class="nav-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </button>
                
                <button class="nav-item" data-section="ventas-insumos">
                    <i class="fas fa-box"></i>
                    <span>Venta de Insumos</span>
                </button>
                
                <button class="nav-item" data-section="presupuestos">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Presupuestos</span>
                </button>
                
                <button class="nav-item" data-section="trabajos">
                    <i class="fas fa-tools"></i>
                    <span>Trabajos</span>
                </button>
                
                <button class="nav-item" data-section="facturacion"> 
                    <i class="fas fa-file-invoice"></i>
                    <span>Facturación</span>
                </button>
                
                <button class="nav-item" data-section="consultas">
                    <i class="fas fa-search"></i>
                    <span>Consultas</span>
                </button>
                
                <button class="nav-item" data-section="gastos">
                    <i class="fas fa-receipt"></i>
                    <span>Gastos</span>
                </button>
                
                <button class="nav-item" data-section="reportes">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reportes <i class="fas fa-lock" style="font-size: 0.7em; opacity: 0.7;"></i></span>
                </button>
                
                <button class="nav-item" data-section="configuracion">
                    <i class="fas fa-cog"></i>
                    <span>Configuración</span>
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="breadcrumb" id="breadcrumb">
                        Dashboard
                    </div>
                </div>
                
                <div class="header-right">
                    <button class="btn btn-danger" id="logoutBtn" title="Cerrar Sesión">
                        <i class="fas fa-sign-out-alt"></i>
                        Cerrar Sesión
                    </button>
                </div>
            </header>

            <div class="content-area" id="contentArea">
                <!-- Dashboard Section -->
                <section id="dashboard-section" class="content-section">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-tools"></i>
                            </div>
                            <div class="stat-value" id="trabajosActivos">0</div>
                            <div class="stat-label">Trabajos Activos</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-value" id="presupuestosPendientes">0</div>
                            <div class="stat-label">Presupuestos Pendientes</div>
                        </div>
                           <div class="stat-card">
                               <div class="stat-icon warning">
                                   <i class="fas fa-file-invoice-dollar"></i>
                               </div>
                               <div class="stat-value" id="facturasPendientes">0</div>
                               <div class="stat-label">Facturas Pendientes de Pago</div>
                           </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <h2 class="card-title">Trabajos en Proceso</h2>
                                <button class="btn btn-primary" onclick="showSection('trabajos')">
                                    Ver Todos
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Vehículo</th>
                                            <th>Estado</th>
                                            <th>Total</th>
                                            <th>Fecha</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trabajosRecientes">
                                        <tr>
                                            <td colspan="5" style="text-align: center; color: var(--text-secondary);">
                                                No hay trabajos registrados
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Ventas de Insumos Section -->
                <section id="ventas-insumos-section" class="content-section hidden">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="card-title">Venta de Insumos</h2>
                            <button class="btn btn-primary" onclick="showVentaInsumoModal()">
                                <i class="fas fa-plus"></i>
                                Nueva Venta
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Nº</th>
                                            <th>Cliente</th>
                                            <th>Fecha</th>
                                            <th>Total Costo</th>
                                            <th>Total Venta</th>
                                            <th>Margen</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ventasInsumosTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Presupuestos Section -->
                <section id="presupuestos-section" class="content-section hidden">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="card-title">Gestión de Presupuestos</h2>
                            <button class="btn btn-primary" onclick="showPresupuestoModal()">
                                <i class="fas fa-plus"></i>
                                Nuevo Presupuesto
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Nº</th>
                                            <th>Cliente</th>
                                            <th>Vehículo</th>
                                            <th>Total</th>
                                            <th>Estado</th>
                                            <th>Fecha</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="presupuestosTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Trabajos Section -->
                <section id="trabajos-section" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Gestión de Trabajos</h2>
                            <div style="display: flex; gap: 0.5rem; margin-left: auto;">
                                <button class="btn btn-secondary" onclick="showTrabajoFromPresupuesto()">
                                    <i class="fas fa-file-import"></i>
                                    Desde Presupuesto
                                </button>
                                <button class="btn btn-primary" onclick="showTrabajoModal()">
                                    <i class="fas fa-plus"></i>
                                    Nuevo Trabajo
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Nº</th>
                                            <th>Cliente</th>
                                            <th>Vehículo</th>
                                            <th>Estado</th>
                                            <th>Total</th>
                                            <th>Margen</th>
                                            <th>Fecha Ingreso</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trabajosTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Gastos Section -->
                <section id="gastos-section" class="content-section hidden">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="card-title">Gastos Operativos</h2>
                            <button class="btn btn-primary" onclick="showGastoModal()">
                                <i class="fas fa-plus"></i>
                                Nuevo Gasto
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="form-grid" style="margin-bottom: 1.5rem;">
                                <div class="form-group">
                                    <label class="form-label">Filtrar por Categoría</label>
                                    <select class="form-input" id="filtroCategoria" onchange="loadGastos()">
                                        <option value="">Todas las categorías</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Mes/Año</label>
                                    <input type="month" class="form-input" id="filtroMes" onchange="loadGastos()">
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Categoría</th>
                                            <th>Descripción</th>
                                            <th>Monto</th>
                                            <th>Recurrente</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gastosTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Facturación Section -->
                <section id="facturacion-section" class="content-section hidden">
                    <div class="card">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="card-title">Facturación</h2>
                            <button class="btn btn-primary" onclick="showFacturaModal()">
                                <i class="fas fa-plus"></i>
                                Nueva Factura
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Nº Factura</th>
                                            <th>Cliente</th>
                                            <th>Total</th>
                                            <th>Estado Pago</th>
                                            <th>Medio de Pago</th>
                                            <th>Fecha</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="facturasTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Consultas Section -->
                <section id="consultas-section" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Consulta de Trabajos</h2>
                        </div>
                        <div class="card-body">
                            <div class="form-grid" style="margin-bottom: 1.5rem;">
                                <div class="form-group">
                                    <label class="form-label">Cliente</label>
                                    <input type="text" class="form-input" id="consultaCliente" placeholder="Nombre del cliente" oninput="formatTitleCase(this)">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Fecha Desde</label>
                                    <input type="date" class="form-input" id="consultaFechaDesde">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Fecha Hasta</label>
                                    <input type="date" class="form-input" id="consultaFechaHasta">
                                </div>
                                <div class="form-group" style="display: flex; align-items: end; margin-left: auto;">
                                    <button class="btn btn-primary" onclick="realizarConsulta()">
                                        <i class="fas fa-search"></i>
                                        Buscar
                                    </button>
                                </div>
                            </div>
                            
                            <div id="consultaResultados"></div>
                        </div>
                    </div>
                </section>

                <!-- Reportes Section -->
                <section id="reportes-section" class="content-section hidden">
                    <!-- Selector de mes -->
                    <div style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                        <label style="font-weight: 500; color: var(--text-primary);">Consultar mes:</label>
                        <select id="selectorMes" class="form-input" style="width: auto; min-width: 150px;" onchange="updateReportesByMonth()">
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="resetToCurrentMonth()">
                            <i class="fas fa-calendar-day"></i> Mes Actual
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Resumen Mensual</h3>
                            </div>
                            <div class="card-body">
                                <div id="resumenFinanciero"></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Gastos por Categoría</h3>
                            </div>
                            <div class="card-body">
                                <div id="gastosChart"></div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Evolución Mensual</h3>
                                <div id="evolucionMensualTrend" style="font-size: 1.2em; margin-left: 0.5em;"></div>
                            </div>
                            <div class="card-body">
                                <div id="evolucionChart"></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Evolución Semanal</h3>
                                <div id="evolucionSemanalTrend" style="font-size: 1.2em; margin-left: 0.5em;"></div>
                            </div>
                            <div class="card-body">
                                <div id="evolucionSemanalChart"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Configuración Section -->
                <section id="configuracion-section" class="content-section hidden">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Configuración del Taller</h2>
                        </div>
                        <div class="card-body">
                            <form id="configuracionForm">
                                <div class="form-grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Nombre del Taller *</label>
                                        <input type="text" class="form-input" id="confNombreTaller" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Dirección</label>
                                        <input type="text" class="form-input" id="confDireccion">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Teléfono</label>
                                        <input type="tel" class="form-input" id="confTelefono" oninput="formatTelefono(this)">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-input" id="confEmail">
                                    </div>
                                </div>
                                
                                <div style="margin: 2rem 0;">
                                    <h3>Gestión de Datos</h3>
                                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                                            <i class="fas fa-upload"></i>
                                            Importar Backup
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="createBackup()">
                                            <i class="fas fa-download"></i>
                                            Crear Backup
                                        </button>
                                    </div>
                                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importBackup(this.files[0])">
                                </div>
                                
                                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i>
                                        Guardar Configuración
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Trabajo Modal -->
    <div class="modal-overlay" id="trabajoModal">
        <div class="modal" style="width: 90%; max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title">Nuevo Trabajo</h3>
                <button class="modal-close" onclick="hideTrabajoModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="trabajoForm">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label class="form-label">Cliente *</label>
                            <input type="text" class="form-input" id="trabajoCliente" list="trabajoClientesList" required oninput="handleTrabajoClienteInput(); formatTitleCase(this)" onchange="handleTrabajoClienteChange()">
                            <datalist id="trabajoClientesList">
                            </datalist>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" class="form-input" id="trabajoTelefono" oninput="formatTelefono(this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vehículo *</label>
                            <input type="text" class="form-input" id="trabajoVehiculo" list="vehiculosList" required oninput="formatTitleCase(this)">
                            <datalist id="vehiculosList">
                            </datalist>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Patente</label>
                            <input type="text" class="form-input" id="trabajoPlaca" oninput="formatPlaca(this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha Ingreso</label>
                            <input type="date" class="form-input" id="trabajoFechaIngreso" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select class="form-input" id="trabajoEstado">
                                <option value="En Proceso">En Proceso</option>
                                <option value="Completado">Completado</option>
                                <option value="Entregado">Entregado</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Diagnóstico</label>
                        <textarea class="form-input" id="trabajoDiagnostico" rows="3"></textarea>
                    </div>

                    <div class="card" style="margin: 1.5rem 0;">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h4>Repuestos/Materiales</h4>
                            <button type="button" class="btn btn-secondary" onclick="addTrabajoRepuesto()">
                                <i class="fas fa-plus"></i>
                                Agregar
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="trabajoRepuestosContainer"></div>
                        </div>
                    </div>

                    <div class="card" style="margin: 1.5rem 0;">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h4>Mano de Obra</h4>
                            <button type="button" class="btn btn-secondary" onclick="addTrabajoManoObra()">
                                <i class="fas fa-plus"></i>
                                Agregar Trabajo
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="trabajoManoObraContainer"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 500px; margin-left: auto;">
                                <div><strong>Costo Total Insumos:</strong></div>
                                <div id="costoInsumos">$0</div>
                                
                                <div><strong>Total:</strong></div>
                                <div id="precioVenta">$0</div>
                                
                                <div><strong>Margen de Ganancia:</strong></div>
                                <div id="margenGanancia">$0 (0%)</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="hideTrabajoModal()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Guardar Trabajo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar trabajo -->
    <div class="modal-overlay" id="trabajoViewModal">
        <div class="modal" style="width: 90%; max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Ver Trabajo</h3>
                <button class="modal-close" onclick="hideTrabajoViewModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="trabajoViewContent">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="hideTrabajoViewModal()">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Factura View Modal -->
    <div class="modal-overlay" id="facturaViewModal">
        <div class="modal" style="width: 90%; max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Visualizar Factura</h3>
                <button class="modal-close" onclick="hideFacturaViewModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="facturaViewContent">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="hideFacturaViewModal()">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gasto Modal -->
    <div class="modal-overlay" id="gastoModal">
        <div class="modal" style="width: 90%; max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Nuevo Gasto</h3>
                <button class="modal-close" onclick="hideGastoModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="gastoForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Fecha *</label>
                            <input type="date" class="form-input" id="gastoFecha" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Categoría *</label>
                            <select class="form-input" id="gastoCategoria" required>
                                <option value="">Seleccionar categoría</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Descripción</label>
                            <input type="text" class="form-input" id="gastoDescripcion" oninput="formatTitleCase(this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monto *</label>
                            <input type="number" class="form-input" id="gastoMonto" min="0" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="gastoRecurrente">
                            <span>Gasto Recurrente (mensual)</span>
                        </label>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="hideGastoModal()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Guardar Gasto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Factura Modal -->
    <div class="modal-overlay" id="facturaModal">
        <div class="modal" style="width: 90%; max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Nueva Factura</h3>
                <button class="modal-close" onclick="hideFacturaModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="facturaForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Trabajo Asociado</label>
                            <select class="form-input" id="facturaTrabajoId" onchange="loadTrabajoForFactura()">
                                <option value="">Seleccionar trabajo completado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cliente *</label>
                            <input type="text" class="form-input" id="facturaCliente" required oninput="formatTitleCase(this)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha Factura *</label>
                            <input type="date" class="form-input" id="facturaFecha" required>
                        </div>
                    </div>

                    <div id="facturaDetalles"></div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="hideFacturaModal()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Generar Factura
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Seleccionar Presupuesto Modal -->
    <div class="modal-overlay" id="presupuestoSelectModal">
        <div class="modal" style="width: 90%; max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Seleccionar Presupuesto</h3>
                <button class="modal-close" onclick="hidePresupuestoSelectModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nº</th>
                                <th>Cliente</th>
                                <th>Vehículo</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="presupuestosSelectTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Venta de Insumos -->
    <div class="modal-overlay" id="ventaInsumoModal">
        <div class="modal" style="width: 90%; max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title">Nueva Venta de Insumos</h3>
                <button class="modal-close" onclick="hideVentaInsumoModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="ventaInsumoForm">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label class="form-label">Cliente</label>
                            <input type="text" class="form-input" id="ventaInsumoCliente" oninput="formatTitleCase(this)">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" class="form-input" id="ventaInsumoTelefono" oninput="formatTelefono(this)">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Fecha *</label>
                            <input type="date" class="form-input" id="ventaInsumoFecha" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Método de Pago</label>
                            <select class="form-input" id="ventaInsumoMetodoPago">
                                <option value="Efectivo">Efectivo</option>
                                <option value="MercadoPago">MercadoPago</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                    </div>

                    <!-- Sección de Insumos -->
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4>Insumos/Repuestos</h4>
                            <button type="button" class="btn btn-secondary" onclick="addVentaInsumoItem()">
                                <i class="fas fa-plus"></i>
                                Agregar Insumo
                            </button>
                        </div>
                        <div id="ventaInsumoItemsContainer">
                            <!-- Items se agregan dinámicamente -->
                        </div>
                    </div>

                    <!-- Totales -->
                    <div class="totals-section">
                        <div class="totals-grid">
                            <div class="total-item">
                                <strong>Total Costo: </strong><span id="totalCostoVentaInsumo">$0</span>
                            </div>
                            <div class="total-item">
                                <strong>Total Venta: </strong><span id="totalVentaInsumo">$0</span>
                            </div>
                            <div class="total-item">
                                <strong>Margen: </strong><span id="margenVentaInsumo">$0</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="btn-group" style="display: flex !important; justify-content: flex-end !important; gap: 10px; margin-right: 25px; margin-bottom: 25px;">
                    <button type="button" class="btn btn-secondary" onclick="hideVentaInsumoModal()">
                        Cancelar
                    </button>
                    <button type="submit" form="ventaInsumoForm" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Guardar Venta
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar venta de insumos -->
    <div class="modal-overlay" id="ventaInsumoViewModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Ver Venta de Insumos</h3>
                <button class="modal-close" onclick="hideVentaInsumoViewModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="ventaInsumoViewContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="hideVentaInsumoViewModal()">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="presupuestoModal">
        <div class="modal" style="width: 90%; max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title">Nuevo Presupuesto</h3>
                <button class="modal-close" onclick="hidePresupuestoModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="presupuestoForm">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label class="form-label">Cliente *</label>
                            <input type="text" class="form-input" id="clienteNombre" list="clientesList" required oninput="handleClienteInput(); formatTitleCase(this)" onchange="handleClienteChange()">
                            <datalist id="clientesList">
                            </datalist>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" class="form-input" id="clienteTelefono" oninput="formatTelefono(this)">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Vehículo *</label>
                            <input type="text" class="form-input" id="vehiculo" list="vehiculosPresupuestoList" required placeholder="Marca Modelo Año" oninput="formatTitleCase(this)">
                            <datalist id="vehiculosPresupuestoList">
                            </datalist>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Patente</label>
                            <input type="text" class="form-input" id="placa" oninput="formatPlaca(this)">
                        </div>
                        
                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label">Diagnóstico *</label>
                            <textarea class="form-input" id="presupuestoDiagnostico" rows="3" required placeholder="Describa el problema y la solución propuesta..."></textarea>
                        </div>
                    </div>

                    <div class="card" style="margin: 1.5rem 0;">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h4>Repuestos/Materiales</h4>
                            <button type="button" class="btn btn-secondary" onclick="addRepuesto()">
                                <i class="fas fa-plus"></i>
                                Agregar
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="repuestosContainer">
                                <!-- Dynamic repuesto rows will be added here -->
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin: 1.5rem 0;">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h4>Mano de Obra</h4>
                            <button type="button" class="btn btn-secondary" onclick="addManoObra()">
                                <i class="fas fa-plus"></i>
                                Agregar Trabajo
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="manoObraContainer">
                                <!-- Dynamic mano obra rows will be added here -->
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div style="text-align: right;">
                                <div style="font-size: 1.25rem; font-weight: 600; color: var(--primary-color);">
                                    <strong>Total: </strong><span id="totalPresupuesto">$0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="hidePresupuestoModal()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Guardar Presupuesto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para visualizar presupuesto -->
    <div class="modal-overlay" id="presupuestoViewModal">
        <div class="modal" style="width: 90%; max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Ver Presupuesto</h3>
                <button class="modal-close" onclick="hidePresupuestoViewModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="presupuestoViewContent">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="hidePresupuestoViewModal()">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal for Reportes -->
    <div class="modal-overlay" id="passwordModal">
        <div class="modal" style="width: 90%; max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">🔐 Acceso Restringido</h3>
                <button class="modal-close" onclick="hidePasswordModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 1.5rem; color: #6c757d;">
                    <i class="fas fa-shield-alt" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <p style="margin: 0; font-size: 0.9rem;">La sección de <strong>Reportes</strong> contiene información sensible del taller.</p>
                </div>
                <form id="passwordForm" onsubmit="checkPassword(event)">
                    <div class="form-group">
                        <label class="form-label">Ingrese la contraseña de acceso:</label>
                        <input type="password" class="form-input" id="passwordInput" placeholder="••••••••" required autocomplete="off">
                        <div id="passwordError" style="color: #e74c3c; font-size: 0.875rem; margin-top: 0.5rem; display: none;">
                            ❌ Contraseña incorrecta. Intente nuevamente.
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="hidePasswordModal()">
                            ❌ Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            🔓 Acceder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <script>
        // Global variables
        let currentSection = 'dashboard';
        let app = null;
        let database = null;
        let appData = {
            presupuestos: [],
            trabajos: [],
            gastos: [],
            facturas: [],
            ventasInsumos: [],
            clientes: [],
            configuracion: {
                nombreTaller: 'Taller RUTA D',
                direccion: '',
                telefono: '',
                email: '',
                logo: '',
                // iva removed
                categorias: [
                    'Alquiler',
                    'Salarios',
                    'Servicios',
                    'Impuestos',
                    'Mercaderías',
                    'Compras',
                    'Otros'
                ]
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            // Setup event listeners first (for login form)
            setupEventListeners();
            
            try {
                // Initialize Firebase (includes auth setup)
                await initializeFirebase();
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showToast('Error al inicializar la aplicación', 'error');
                // Still show login screen even if Firebase fails
                showLoginScreen();
            }
        });

        async function initializeFirebase() {
            try {
                // Import Firebase modules
                const { initializeApp } = await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js");
                const { getDatabase, ref, set, get, child, onValue, push, update, remove } = await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js");
                const { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js");
                
                // Firebase configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyCE_fwXgWSSv7YKwTarXi9MBngOvOg1F_E",
                    authDomain: "rutad-bdeb2.firebaseapp.com",
                    databaseURL: "https://rutad-bdeb2-default-rtdb.firebaseio.com",
                    projectId: "rutad-bdeb2",
                    storageBucket: "rutad-bdeb2.firebasestorage.app",
                    messagingSenderId: "478384272388",
                    appId: "1:478384272388:web:7fc9cde58bd9c516f8f151"
                };

                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                database = getDatabase(app);
                
                // Initialize Firebase Auth
                const auth = getAuth(app);
                
                // Store Firebase functions globally for later use
                window.firebaseRef = ref;
                window.firebaseSet = set;
                window.firebaseGet = get;
                window.firebaseChild = child;
                window.firebaseOnValue = onValue;
                window.firebasePush = push;
                window.firebaseUpdate = update;
                window.firebaseRemove = remove;
                
                // Store Auth functions globally
                window.firebaseAuth = auth;
                window.firebaseSignIn = signInWithEmailAndPassword;
                window.firebaseSignOut = signOut;
                window.firebaseOnAuthStateChanged = onAuthStateChanged;
                
                // Set up authentication state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log('User is signed in:', user.email);
                        showMainApp();
                        // Load data only after authentication
                        loadFirebaseData().then(() => {
                            initializeApp_Internal();
                        });
                    } else {
                        console.log('User is signed out');
                        showLoginScreen();
                    }
                });
                
                showToast('Firebase inicializado correctamente', 'success');
            } catch (error) {
                console.error('Error initializing Firebase:', error);
                showToast('Error al conectar con Firebase', 'error');
                // Show login screen even if Firebase fails, but with fallback
                showLoginScreen();
            }
        }

        function initializeApp_Internal() {
            
            // Poblar caché de vehículos con datos existentes
            populateVehiculosCache();
            
            // Update dashboard
            updateDashboard();
            
            // Show initial section
            showSection('dashboard');
        }

        // Authentication Functions
        function showLoginScreen() {
            document.body.classList.remove('authenticated');
            document.getElementById('loginScreen').style.display = 'flex';
            document.querySelector('.app-container').style.display = 'none';
        }

        function showMainApp() {
            document.body.classList.add('authenticated');
            document.getElementById('loginScreen').style.display = 'none';
            document.querySelector('.app-container').style.display = 'flex';
            
            // Setup additional event listeners for main app (but not login-related ones again)
            setupMainAppEventListeners();
            showSection('dashboard');
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            
            // Clear previous errors
            loginError.style.display = 'none';
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando sesión...';
            
            try {
                const auth = window.firebaseAuth;
                await window.firebaseSignIn(auth, email, password);
                // Success - onAuthStateChanged will handle the rest
            } catch (error) {
                console.error('Login error:', error);
                
                // Show error message
                let errorMessage = 'Error al iniciar sesión. Verifica tus credenciales.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No existe una cuenta con este correo electrónico.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Contraseña incorrecta.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Correo electrónico inválido.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Demasiados intentos fallidos. Intenta más tarde.';
                }
                
                loginError.textContent = errorMessage;
                loginError.style.display = 'block';
            } finally {
                // Reset button state
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesión';
            }
        }

        async function handleLogout() {
            try {
                const auth = window.firebaseAuth;
                await window.firebaseSignOut(auth);
                showToast('Sesión cerrada exitosamente', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Error al cerrar sesión', 'error');
            }
        }

        function setupEventListeners() {
            // Login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            // Logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        }

        function setupMainAppEventListeners() {
            // Cierre de modales con Escape y clic fuera
            const modalIds = [
                'trabajoModal', 'trabajoViewModal', 'facturaViewModal', 'gastoModal', 'facturaModal',
                'presupuestoSelectModal', 'presupuestoModal', 'presupuestoViewModal', 'passwordModal'
            ];
            modalIds.forEach(id => {
                const overlay = document.getElementById(id);
                if (overlay) {
                    overlay.addEventListener('mousedown', function(e) {
                        if (e.target === overlay) {
                            overlay.classList.remove('show');
                        }
                    });
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    modalIds.forEach(id => {
                        const overlay = document.getElementById(id);
                        if (overlay && overlay.classList.contains('show')) {
                            overlay.classList.remove('show');
                        }
                    });
                }
            });
            // Menu toggle
            const menuToggle = document.getElementById('menuToggle');
            if (menuToggle) {
                menuToggle.addEventListener('click', toggleSidebar);
            }
            
            // Cerrar menú tocando fuera en móvil
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('show');
                        this.classList.add('hidden');
                    }
                });
            }
            
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.dataset.section;
                    
                    // Special handling for reportes section - require password
                    if (section === 'reportes') {
                        showPasswordModal();
                        return;
                    }
                    
                    showSection(section);
                });
            });

            // Sync button
            const syncBtn = document.getElementById('syncBtn');
            if (syncBtn) {
                syncBtn.addEventListener('click', createFirebaseBackup);
            }

            // Presupuesto form
            const presupuestoForm = document.getElementById('presupuestoForm');
            if (presupuestoForm) {
                presupuestoForm.addEventListener('submit', handlePresupuestoSubmit);
            }
            
            // Trabajo form
            const trabajoForm = document.getElementById('trabajoForm');
            if (trabajoForm) {
                trabajoForm.addEventListener('submit', handleTrabajoSubmit);
            }
            
            // Venta Insumo form
            const ventaInsumoForm = document.getElementById('ventaInsumoForm');
            if (ventaInsumoForm) {
                ventaInsumoForm.addEventListener('submit', handleVentaInsumoSubmit);
            }
            
            // Gasto form
            const gastoForm = document.getElementById('gastoForm');
            if (gastoForm) {
                gastoForm.addEventListener('submit', handleGastoSubmit);
            }
            
            // Factura form
            const facturaForm = document.getElementById('facturaForm');
            if (facturaForm) {
                facturaForm.addEventListener('submit', handleFacturaSubmit);
            }
            
            // Configuración form
            const configuracionForm = document.getElementById('configuracionForm');
            if (configuracionForm) {
                configuracionForm.addEventListener('submit', handleConfiguracionSubmit);
            }
            
            // Set default dates
            const trabajoFechaIngreso = document.getElementById('trabajoFechaIngreso');
            if (trabajoFechaIngreso) {
                trabajoFechaIngreso.value = new Date().toISOString().split('T')[0];
            }
            
            const gastoFecha = document.getElementById('gastoFecha');
            if (gastoFecha) {
                gastoFecha.value = new Date().toISOString().split('T')[0];
            }
            
            const facturaFecha = document.getElementById('facturaFecha');
            if (facturaFecha) {
                facturaFecha.value = new Date().toISOString().split('T')[0];
            }
            
            // Add auto-complete functionality
            setupAutoComplete();
        }

        function setupAutoComplete() {
            // Auto-complete for cliente names
            const clienteInputs = ['clienteNombre', 'trabajoCliente', 'facturaCliente'];
            clienteInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', function() {
                        showClienteSuggestions(this);
                    });
                }
            });
        }

        function showClienteSuggestions(input) {
            const value = input.value.toLowerCase();
            if (value.length < 2) return;
            
            // Get unique client names from all sources
            const clientes = new Set();
            appData.presupuestos.forEach(p => clientes.add(p.cliente.nombre));
            appData.trabajos.forEach(t => clientes.add(t.cliente));
            appData.facturas.forEach(f => clientes.add(f.cliente));
            
            const matches = Array.from(clientes).filter(cliente => 
                cliente.toLowerCase().includes(value)
            );
            
            // Create datalist for suggestions
            let datalist = document.getElementById('clientesDatalist');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'clientesDatalist';
                document.body.appendChild(datalist);
            }
            
            datalist.innerHTML = '';
            matches.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente;
                datalist.appendChild(option);
            });
            
            input.setAttribute('list', 'clientesDatalist');
        }

        // Additional helper functions for complete functionality
        function viewPresupuesto(presupuestoId) {
            const presupuesto = appData.presupuestos.find(p => p.id === presupuestoId);
            if (!presupuesto) return;
            
            // Populate view modal content
            let content = `
                <div class="view-details">
                    <div class="view-header">
                        <h4>PRESUPUESTO #${presupuesto.numero}</h4>
                        <span class="badge ${presupuesto.estado === 'Aprobado' ? 'badge-success' : presupuesto.estado === 'Rechazado' ? 'badge-danger' : 'badge-warning'}">
                            ${presupuesto.estado}
                        </span>
                    </div>
                    
                    <div class="view-section">
                        <h5>Información del Cliente</h5>
                        <p><strong>Cliente:</strong> ${presupuesto.cliente.nombre}</p>
                        <p><strong>Teléfono:</strong> ${presupuesto.cliente.telefono || 'N/A'}</p>
                        <p><strong>Vehículo:</strong> ${presupuesto.vehiculo}</p>
                        <p><strong>Patente:</strong> ${presupuesto.placa || 'N/A'}</p>
                        <p><strong>Fecha:</strong> ${formatDate(presupuesto.fecha)}</p>
                    </div>
            `;
            
            if (presupuesto.repuestos && presupuesto.repuestos.length > 0) {
                content += `
                    <div class="view-section">
                        <h5>Repuestos</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Cantidad</th>
                                    <th>Valor</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                presupuesto.repuestos.forEach(rep => {
                    content += `
                        <tr>
                            <td>${rep.descripcion}</td>
                            <td>${rep.cantidad}</td>
                            <td>${formatCurrency(rep.precio)}</td>
                            <td>${formatCurrency(rep.cantidad * rep.precio)}</td>
                        </tr>
                    `;
                });
                content += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            if (presupuesto.manoObra && presupuesto.manoObra.length > 0) {
                content += `
                    <div class="view-section">
                        <h5>Mano de Obra</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                presupuesto.manoObra.forEach(mo => {
                    content += `
                        <tr>
                            <td>${mo.descripcion}</td>
                            <td>${formatCurrency(mo.valor)}</td>
                        </tr>
                    `;
                });
                content += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            content += `
                    <div class="view-section">
                        <div class="total-section">
                            <h4>TOTAL: ${formatCurrency(presupuesto.total)}</h4>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('presupuestoViewContent').innerHTML = content;
            document.getElementById('presupuestoViewModal').classList.add('show');
        }

        function hidePresupuestoViewModal() {
            document.getElementById('presupuestoViewModal').classList.remove('show');
        }

        // Password Modal Functions
        function showPasswordModal() {
            document.getElementById('passwordModal').classList.add('show');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            setTimeout(() => {
                document.getElementById('passwordInput').focus();
            }, 100);
        }

        function hidePasswordModal() {
            const wasVisible = document.getElementById('passwordModal').classList.contains('show');
            document.getElementById('passwordModal').classList.remove('show');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            
            // Show discrete message when user cancels
            if (wasVisible) {
                showToast('🔒 Acceso a Reportes cancelado', 'info');
            }
        }

        function checkPassword(event) {
            event.preventDefault();
            const password = document.getElementById('passwordInput').value;
            const correctPassword = '1213122';
            
            if (password === correctPassword) {
                hidePasswordModal();
                // Proceed to show reportes section
                showSection('reportes');
                showToast('🔓 Acceso concedido a Reportes', 'success');
            } else {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
                // More discrete error message
                setTimeout(() => {
                    document.getElementById('passwordError').style.display = 'none';
                }, 3000);
            }
        }

        function editPresupuesto(presupuestoId) {
            const presupuesto = appData.presupuestos.find(p => p.id === presupuestoId);
            if (!presupuesto) return;
            
            // Clear form first
            clearPresupuestoForm();
            
            // Load vehicle suggestions
            loadVehiculosDatalist('vehiculosPresupuestoList');
            
            // Pre-fill form for editing - handle different cliente structures
            let clienteNombre = '';
            let clienteTelefono = '';
            
            if (typeof presupuesto.cliente === 'string') {
                clienteNombre = presupuesto.cliente;
                clienteTelefono = presupuesto.telefono || '';
            } else if (presupuesto.cliente && presupuesto.cliente.nombre) {
                clienteNombre = presupuesto.cliente.nombre;
                clienteTelefono = presupuesto.cliente.telefono || presupuesto.telefono || '';
            }
            
            document.getElementById('clienteNombre').value = clienteNombre;
            document.getElementById('clienteTelefono').value = clienteTelefono;
            document.getElementById('vehiculo').value = presupuesto.vehiculo;
            document.getElementById('placa').value = presupuesto.placa || '';
            document.getElementById('presupuestoDiagnostico').value = presupuesto.diagnostico || '';
            
            // Load repuestos
            if (presupuesto.repuestos && presupuesto.repuestos.length > 0) {
                presupuesto.repuestos.forEach(repuesto => {
                    addRepuesto();
                    const lastRow = document.getElementById('repuestosContainer').lastElementChild;
                    lastRow.querySelector('.repuesto-desc').value = repuesto.descripcion;
                    lastRow.querySelector('.repuesto-cant').value = repuesto.cantidad;
                    lastRow.querySelector('.repuesto-precio').value = repuesto.precio;
                });
            }
            
            // Load mano de obra
            if (presupuesto.manoObra && presupuesto.manoObra.length > 0) {
                presupuesto.manoObra.forEach(trabajo => {
                    addManoObra();
                    const lastRow = document.getElementById('manoObraContainer').lastElementChild;
                    lastRow.querySelector('.trabajo-desc').value = trabajo.descripcion;
                    lastRow.querySelector('.trabajo-valor').value = trabajo.valor;
                });
            }
            
            updatePresupuestoTotals();
            
            // Set editing mode
            document.getElementById('presupuestoForm').dataset.editingId = presupuestoId;
            document.querySelector('#presupuestoModal .modal-title').textContent = 'Editar Presupuesto';
            
            // Show modal without clearing the form
            document.getElementById('presupuestoModal').classList.add('show');
        }

        async function deletePresupuesto(presupuestoId) {
            if (confirm('¿Está seguro de que desea eliminar este presupuesto?')) {
                // Find presupuesto to get Firebase ID
                const presupuesto = appData.presupuestos.find(p => p.id === presupuestoId);
                
                // Remove from local data
                appData.presupuestos = appData.presupuestos.filter(p => p.id !== presupuestoId);
                
                // Remove from Firebase
                if (presupuesto && presupuesto.firebaseId) {
                    await deleteFromFirebase('presupuestos', presupuesto.firebaseId);
                }
                
                loadPresupuestos();
                showToast('Presupuesto eliminado', 'success');
            }
        }

        function printPresupuesto(presupuestoId) {
            const presupuesto = appData.presupuestos.find(p => p.id === presupuestoId);
            if (!presupuesto) return;
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(generatePresupuestoPrint(presupuesto));
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        function generatePresupuestoPrint(presupuesto) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Presupuesto ${presupuesto.numero}</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body { 
                            font-family: 'Arial', sans-serif; 
                            line-height: 1.6;
                            color: #333;
                            background: white;
                            padding: 30px 20px;
                            max-width: 700px;
                            margin: 0 auto;
                            font-size: 14px;
                        }
                        
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #eee;
                            padding-bottom: 20px;
                        }
                        
                        .header h1 {
                            font-size: 2.2em;
                            margin-bottom: 8px;
                            color: #333;
                            font-weight: bold;
                        }
                        
                        .header .contact {
                            font-size: 1em;
                            color: #666;
                            line-height: 1.4;
                        }
                        
                        .presupuesto-info {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 25px;
                            padding: 15px 0;
                        }
                        
                        .client-info, .presupuesto-details {
                            width: 48%;
                        }
                        
                        .client-info h3, .presupuesto-details h3 {
                            font-size: 1.3em;
                            margin-bottom: 12px;
                            color: #555;
                            border-bottom: 1px solid #eee;
                            padding-bottom: 6px;
                        }
                        
                        .info-line {
                            margin-bottom: 10px;
                            font-size: 1.1em;
                        }
                        
                        .info-line strong {
                            color: #333;
                        }
                        
                        .table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                        }
                        
                        .table th, .table td {
                            border: 1px solid #ddd;
                            padding: 14px 10px;
                            text-align: left;
                            font-size: 1em;
                        }
                        
                        .table th {
                            background: #f8f9fa;
                            font-weight: bold;
                            color: #555;
                        }
                        
                        .text-right {
                            text-align: right;
                        }
                        
                        .section-title {
                            font-size: 1.3em;
                            margin: 25px 0 15px 0;
                            color: #555;
                            border-bottom: 1px solid #eee;
                            padding-bottom: 6px;
                        }
                        
                        .total-section {
                            background: #f8f9fa;
                            padding: 25px;
                            border-radius: 8px;
                            margin-top: 25px;
                            text-align: right;
                        }
                        
                        .total-amount {
                            font-size: 1.6em;
                            font-weight: bold;
                            color: #2c5530;
                            margin-top: 12px;
                        }
                        
                        .diagnostico {
                            background: #f8f9fa;
                            padding: 18px;
                            border-radius: 8px;
                            margin: 20px 0;
                            border-left: 4px solid #007bff;
                        }
                        
                        .diagnostico h3 {
                            margin-bottom: 10px;
                            font-size: 1.2em;
                        }
                        
                        .diagnostico p {
                            font-size: 1em;
                            line-height: 1.5;
                        }
                        
                        @media print {
                            body { 
                                font-size: 13px;
                                padding: 20px 10px;
                            }
                            .header h1 { 
                                font-size: 2em; 
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>PRESUPUESTO</h1>
                        <div class="contact">
                            ${appData.configuracion.nombreTaller || 'Taller RUTA D'}<br>
                            ${appData.configuracion.direccion || 'Dirección del Taller'}<br>
                            Tel: ${appData.configuracion.telefono || '(000) 000-0000'} | Email: ${appData.configuracion.email || 'email@taller.com'}
                        </div>
                    </div>
                    
                    <div class="presupuesto-info">
                        <div class="client-info">
                            <h3>Información del Cliente</h3>
                            <div class="info-line"><strong>Cliente:</strong> ${presupuesto.cliente.nombre}</div>
                            <div class="info-line"><strong>Teléfono:</strong> ${presupuesto.cliente.telefono}</div>
                            <div class="info-line"><strong>Vehículo:</strong> ${presupuesto.vehiculo}</div>
                            <div class="info-line"><strong>Patente:</strong> ${presupuesto.placa}</div>
                        </div>
                        
                        <div class="presupuesto-details">
                            <h3>Detalles del Presupuesto</h3>
                            <div class="info-line"><strong>Número:</strong> ${presupuesto.numero}</div>
                            <div class="info-line"><strong>Fecha:</strong> ${new Date(presupuesto.fecha).toLocaleDateString()}</div>
                            <div class="info-line"><strong>Estado:</strong> ${presupuesto.estado}</div>
                        </div>
                    </div>
                    
                    ${presupuesto.diagnostico ? `
                        <div class="diagnostico">
                            <h3>Diagnóstico</h3>
                            <p>${presupuesto.diagnostico}</p>
                        </div>
                    ` : ''}
                    
                    ${presupuesto.repuestos && presupuesto.repuestos.length > 0 ? `
                        <h3 class="section-title">Repuestos/Materiales</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th class="text-right">Cantidad</th>
                                    <th class="text-right">Precio Unit.</th>
                                    <th class="text-right">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${presupuesto.repuestos.map(item => `
                                    <tr>
                                        <td>${item.descripcion}</td>
                                        <td class="text-right">${item.cantidad}</td>
                                        <td class="text-right">$${item.precio ? item.precio.toLocaleString() : '0'}</td>
                                        <td class="text-right">$${item.subtotal ? item.subtotal.toLocaleString() : '0'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                    
                    ${presupuesto.manoObra && presupuesto.manoObra.length > 0 ? `
                        <h3 class="section-title">Mano de Obra</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th class="text-right">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${presupuesto.manoObra.map(item => `
                                    <tr>
                                        <td>${item.descripcion}</td>
                                        <td class="text-right">$${item.valor ? item.valor.toLocaleString() : '0'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                    
                    <div class="total-section">
                        <div class="total-amount">TOTAL: $${presupuesto.total ? presupuesto.total.toLocaleString() : '0'}</div>
                        <p style="margin-top: 12px; font-size: 1em; color: #666;">
                            Este presupuesto tiene una validez de ___ días
                        </p>
                    </div>
                </body>
                </html>
            `;
        }

        function viewTrabajo(trabajoId) {
            const trabajo = appData.trabajos.find(t => t.id === trabajoId);
            if (!trabajo) return;
            
            // Populate view modal content
            let content = `
                <div class="view-details">
                    <div class="view-header">
                        <h4>TRABAJO #${trabajo.numero}</h4>
                        <span class="badge ${trabajo.estado === 'Completado' ? 'badge-success' : trabajo.estado === 'En Proceso' ? 'badge-warning' : 'badge-success'}">
                            ${trabajo.estado}
                        </span>
                    </div>
                    
                    <div class="view-section">
                        <h5>Información del Cliente</h5>
                        <p><strong>Cliente:</strong> ${trabajo.cliente}</p>
                        <p><strong>Teléfono:</strong> ${trabajo.telefono || 'N/A'}</p>
                        <p><strong>Vehículo:</strong> ${trabajo.vehiculo}</p>
                        <p><strong>Patente:</strong> ${trabajo.placa || 'N/A'}</p>
                        <p><strong>Fecha Ingreso:</strong> ${formatDate(trabajo.fechaIngreso)}</p>
                        <p><strong>Diagnóstico:</strong> ${trabajo.diagnostico || 'N/A'}</p>
                    </div>
            `;
            
            if (trabajo.repuestos && trabajo.repuestos.length > 0) {
                content += `
                    <div class="view-section">
                        <h5>Repuestos/Materiales</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Cantidad</th>
                                    <th>Valor</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                trabajo.repuestos.forEach(rep => {
                    content += `
                        <tr>
                            <td>${rep.descripcion}</td>
                            <td>${rep.cantidad}</td>
                            <td>${formatCurrency(rep.costo)}</td>
                            <td>${formatCurrency(rep.precio)}</td>
                            <td>${formatCurrency(rep.subtotalPrecio)}</td>
                        </tr>
                    `;
                });
                content += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            if (trabajo.manoObra && trabajo.manoObra.length > 0) {
                content += `
                    <div class="view-section">
                        <h5>Mano de Obra</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                trabajo.manoObra.forEach(mo => {
                    content += `
                        <tr>
                            <td>${mo.descripcion}</td>
                            <td>${formatCurrency(mo.valor)}</td>
                        </tr>
                    `;
                });
                content += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            const margenPorcentaje = trabajo.total > 0 ? ((trabajo.margen / trabajo.total) * 100).toFixed(1) : 0;
            content += `
                    <div class="view-section">
                        <div class="view-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <p><strong>Costo Total:</strong> ${formatCurrency(trabajo.costoTotal || 0)}</p>
                                <p><strong>Precio Total:</strong> ${formatCurrency(trabajo.total)}</p>
                            </div>
                            <div>
                                <p><strong>Margen:</strong> ${formatCurrency(trabajo.margen || 0)} (${margenPorcentaje}%)</p>
                            </div>
                        </div>
                        <div class="total-section">
                            <h4>TOTAL: ${formatCurrency(trabajo.total)}</h4>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('trabajoViewContent').innerHTML = content;
            document.getElementById('trabajoViewModal').classList.add('show');
        }

        function hideTrabajoViewModal() {
            document.getElementById('trabajoViewModal').classList.remove('show');
        }

        function editTrabajo(trabajoId) {
            const trabajo = appData.trabajos.find(t => t.id === trabajoId);
            if (!trabajo) return;
            
            // Clear form first
            clearTrabajoForm();
            
            // Load vehicle suggestions
            loadVehiculosDatalist('vehiculosList');
            
            // Pre-fill form for editing
            document.getElementById('trabajoCliente').value = trabajo.cliente;
            document.getElementById('trabajoTelefono').value = trabajo.telefono || '';
            document.getElementById('trabajoVehiculo').value = trabajo.vehiculo;
            document.getElementById('trabajoPlaca').value = trabajo.placa || '';
            document.getElementById('trabajoFechaIngreso').value = trabajo.fechaIngreso;
            document.getElementById('trabajoDiagnostico').value = trabajo.diagnostico || '';
            document.getElementById('trabajoEstado').value = trabajo.estado;
            
            // Load repuestos
            if (trabajo.repuestos && trabajo.repuestos.length > 0) {
                trabajo.repuestos.forEach(repuesto => {
                    addTrabajoRepuesto();
                    const lastRow = document.getElementById('trabajoRepuestosContainer').lastElementChild;
                    lastRow.querySelector('.trabajo-repuesto-desc').value = repuesto.descripcion;
                    lastRow.querySelector('.trabajo-repuesto-cant').value = repuesto.cantidad;
                    lastRow.querySelector('.trabajo-repuesto-costo').value = repuesto.costo;
                    lastRow.querySelector('.trabajo-repuesto-precio').value = repuesto.precio;
                });
            }
            
            // Load mano de obra
            if (trabajo.manoObra && trabajo.manoObra.length > 0) {
                trabajo.manoObra.forEach(mano => {
                    addTrabajoManoObra();
                    const lastRow = document.getElementById('trabajoManoObraContainer').lastElementChild;
                    lastRow.querySelector('.trabajo-trabajo-desc').value = mano.descripcion;
                    lastRow.querySelector('.trabajo-trabajo-valor').value = mano.valor;
                });
            }
            
            updateTrabajoCostos();
            
            // Set editing mode
            document.getElementById('trabajoForm').dataset.editingId = trabajoId;
            document.querySelector('#trabajoModal .modal-title').textContent = 'Editar Trabajo';
            
            // Show modal without clearing the form
            document.getElementById('trabajoModal').classList.add('show');
        }

        async function deleteTrabajo(trabajoId) {
            const trabajo = appData.trabajos.find(t => t.id === trabajoId);
            if (!trabajo) return;
            
            if (confirm(`¿Está seguro de eliminar el trabajo #${trabajo.numero} de ${trabajo.cliente}?`)) {
                // Remove from array
                appData.trabajos = appData.trabajos.filter(t => t.id !== trabajoId);
                
                // Delete from Firebase
                const firebaseKey = trabajo.firebaseId || trabajo.id;
                const deleted = await deleteFromFirebase('trabajos', firebaseKey);
                if (!deleted) {
                    showToast('No se pudo eliminar el trabajo en Firebase', 'error');
                }
                
                // Reload the table
                loadTrabajos();
                
                alert('Trabajo eliminado exitosamente');
            }
        }

        function editGasto(gastoId) {
            const gasto = appData.gastos.find(g => g.id === gastoId);
            if (!gasto) return;
            
            // Set editing mode first
            document.getElementById('gastoForm').dataset.editingId = gastoId;
            document.querySelector('#gastoModal .modal-title').textContent = 'Editar Gasto';
            
            // Show modal and load categories
            loadCategoriasInSelect();
            document.getElementById('gastoModal').classList.add('show');
            
            // Pre-fill form for editing (after showing modal)
            document.getElementById('gastoFecha').value = gasto.fecha;
            document.getElementById('gastoCategoria').value = gasto.categoria;
            document.getElementById('gastoDescripcion').value = gasto.descripcion;
            document.getElementById('gastoMonto').value = gasto.monto;
            document.getElementById('gastoRecurrente').checked = gasto.recurrente;
        }

        function viewFactura(facturaId) {
            const factura = appData.facturas.find(f => f.id === facturaId);
            if (!factura) return;
            
            // Populate view modal content
            let content = `
                <div class="view-details">
                    <div class="view-header">
                        <h4>FACTURA #${factura.numero}</h4>
                        <span class="badge ${factura.estado === 'Pagado' ? 'badge-success' : 'badge-warning'}">
                            ${factura.estado}
                        </span>
                    </div>
                    
                    <div class="view-section">
                        <h5>Información de la Factura</h5>
                        <p><strong>Cliente:</strong> ${factura.cliente}</p>
                        <p><strong>Fecha:</strong> ${formatDate(factura.fecha)}</p>
                        <p><strong>Trabajo:</strong> ${factura.trabajo ? factura.trabajo.numero : 'N/A'}</p>
                    </div>
            `;
            
            if (factura.trabajo && factura.trabajo.repuestos && factura.trabajo.repuestos.length > 0) {
                content += `
                    <div class="view-section">
                        <h5>Repuestos</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unit.</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                factura.trabajo.repuestos.forEach(rep => {
                    content += `
                        <tr>
                            <td>${rep.descripcion}</td>
                            <td>${rep.cantidad}</td>
                            <td>${formatCurrency(rep.precio)}</td>
                            <td>${formatCurrency(rep.subtotalPrecio)}</td>
                        </tr>
                    `;
                });
                content += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            if (factura.trabajo && factura.trabajo.manoObra && factura.trabajo.manoObra.length > 0) {
                content += `
                    <div class="view-section">
                        <h5>Mano de Obra</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                factura.trabajo.manoObra.forEach(mo => {
                    content += `
                        <tr>
                            <td>${mo.descripcion}</td>
                            <td>${formatCurrency(mo.valor)}</td>
                        </tr>
                    `;
                });
                content += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            content += `
                    <div class="view-section">
                        <div class="total-section">
                            <h4>TOTAL: ${formatCurrency(factura.total)}</h4>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('facturaViewContent').innerHTML = content;
            document.getElementById('facturaViewModal').classList.add('show');
        }

        function hideFacturaViewModal() {
            document.getElementById('facturaViewModal').classList.remove('show');
        }

        function printFactura(facturaId) {
            const factura = appData.facturas.find(f => f.id === facturaId);
            if (!factura) return;
            
            // Create print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(generateFacturaPrint(factura));
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        function generateFacturaPrint(factura) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Factura ${factura.numero}</title>
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body { 
                            font-family: 'Arial', sans-serif; 
                            line-height: 1.6;
                            color: #333;
                            background: white;
                            padding: 40px 20px;
                            max-width: 600px;
                            margin: 0 auto;
                        }
                        
                        .header {
                            text-align: center;
                            margin-bottom: 40px;
                            border-bottom: 1px solid #eee;
                            padding-bottom: 20px;
                        }
                        
                        .header h1 {
                            font-size: 1.8em;
                            margin-bottom: 5px;
                            color: #333;
                            font-weight: normal;
                        }
                        
                        .header .contact {
                            font-size: 0.9em;
                            color: #666;
                        }
                        
                        .invoice-info {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 30px;
                            padding: 20px 0;
                        }
                        
                        .client-info, .invoice-details {
                            flex: 1;
                        }
                        
                        .invoice-details {
                            text-align: right;
                        }
                        
                        .info-label {
                            font-size: 1em;
                            color: #666;
                            margin-bottom: 5px;
                        }
                        
                        .info-value {
                            font-size: 1.1em;
                            color: #333;
                            margin-bottom: 15px;
                        }
                        
                        .invoice-number {
                            font-size: 1.5em;
                            font-weight: bold;
                            color: #333;
                        }
                        
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 30px 0;
                        }
                        
                        th, td { 
                            border-bottom: 1px solid #eee; 
                            padding: 12px 0; 
                            text-align: left; 
                        }
                        
                        th { 
                            font-weight: 600;
                            color: #333;
                            font-size: 0.9em;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        td {
                            color: #555;
                        }
                        
                        .text-right {
                            text-align: right;
                        }
                        
                        .total-section {
                            border-top: 2px solid #333;
                            padding-top: 20px;
                            margin-top: 30px;
                            text-align: right;
                        }
                        
                        .total-label {
                            font-size: 1.1em;
                            color: #666;
                            margin-bottom: 5px;
                        }
                        
                        .total-amount {
                            font-size: 2em;
                            font-weight: bold;
                            color: #333;
                        }
                        
                        .status {
                            margin-top: 10px;
                            font-size: 0.9em;
                            color: #666;
                        }
                        
                        .footer {
                            text-align: center;
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 1px solid #eee;
                            font-size: 0.9em;
                            color: #999;
                        }
                        
                        @media print {
                            body { 
                                padding: 20px 0; 
                                font-size: 14px;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-container">
                        <div class="header">
                            <h1>${appData.configuracion.nombreTaller || 'Taller RUTA D'}</h1>
                            <div class="subtitle">
                                ${appData.configuracion.direccion || 'Dirección del Taller'}<br>
                                Tel: ${appData.configuracion.telefono || '(000) 000-0000'} | Email: ${appData.configuracion.email || 'email@taller.com'}
                            </div>
                        </div>
                        
                        <div class="invoice-info">
                            <div class="client-info">
                                <div class="info-row"><strong>Cliente:</strong> ${factura.cliente}</div>
                                <div class="info-row"><strong>Fecha:</strong> ${formatDate(factura.fecha)}</div>
                                <div class="info-row">
                                    <strong>Estado:</strong> 
                                    <span class="status-badge status-${factura.estadoPago?.toLowerCase() || 'pendiente'}">
                                        ${factura.estadoPago || 'Pendiente'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="content">
                            ${factura.detalles?.repuestos && factura.detalles.repuestos.length > 0 ? `
                                <div class="section-title">REPUESTOS Y MATERIALES</div>
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width: 50%">Descripción</th>
                                            <th style="width: 15%">Cant.</th>
                                            <th style="width: 17.5%">Valor</th>
                                            <th style="width: 17.5%">Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${factura.detalles.repuestos.map(r => `
                                            <tr>
                                                <td>${r.descripcion}</td>
                                                <td class="text-center">${r.cantidad}</td>
                                                <td class="text-right">${formatCurrency(r.precio)}</td>
                                                <td class="text-right"><strong>${formatCurrency(r.subtotalPrecio)}</strong></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : ''}
                            
                            ${factura.detalles?.manoObra && factura.detalles.manoObra.length > 0 ? `
                                <div class="section-title">MANO DE OBRA</div>
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width: 70%">Descripción del Trabajo</th>
                                            <th style="width: 30%">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${factura.detalles.manoObra.map(m => `
                                            <tr>
                                                <td>${m.descripcion}</td>
                                                <td class="text-right"><strong>${formatCurrency(m.valor || m.subtotal)}</strong></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : ''}
                        </div>
                        
                        <div class="total-section">
                            <div style="font-size: 1.3em; margin-bottom: 10px;">TOTAL A PAGAR</div>
                            <div class="total-amount">${formatCurrency(factura.total)}</div>
                            <div style="font-size: 1.1em; margin-top: 10px;">
                                ${factura.estadoPago === 'Pagado' ? '✓ PAGADO' : 'PENDIENTE DE PAGO'}
                            </div>
                        </div>
                        
                        <div class="footer">
                            Gracias por confiar en nosotros | ${appData.configuracion.nombreTaller || 'Taller RUTA D'}
                        </div>
                    </div>
                </body>
                </html>
            `;
        }

        async function shareFacturaWhatsApp(facturaId) {
            const factura = appData.facturas.find(f => f.id === facturaId);
            if (!factura) return;
            
            // Obtener teléfono: primero desde factura directamente, luego desde trabajo asociado, finalmente desde clientes
            let telefono = '';
            if (factura.telefono) {
                telefono = factura.telefono;
            } else if (factura.trabajo && factura.trabajo.telefono) {
                telefono = factura.trabajo.telefono;
            } else {
                // Buscar en clientes por nombre
                const cliente = appData.clientes.find(c => c.nombre === factura.cliente);
                if (cliente) {
                    telefono = cliente.telefono;
                }
            }
            
            if (!telefono) {
                showToast('No se encontró número de teléfono para este cliente', 'error');
                return;
            }
            
            // Limpiar el número de teléfono (quitar espacios, guiones, etc.)
            telefono = telefono.replace(/[^\d]/g, '');
            
            // Verificar que tenga al menos 10 dígitos
            if (telefono.length < 10) {
                showToast('El número de teléfono no es válido', 'error');
                return;
            }
            
            // Formatear número para WhatsApp (agregar código de país si no lo tiene)
            if (!telefono.startsWith('54')) {
                telefono = '54' + telefono;
            }
            
            showToast('Generando imagen de la factura...', 'info');
            
            try {
                // Generar imagen de la factura
                const imageDataUrl = await generateFacturaImage(factura);
                
                // Crear mensaje simple para acompañar la imagen
                const mensaje = `¡Hola ${factura.cliente}!

                Adjunto tu recibo #${factura.numero} por ${formatCurrency(factura.total)}, junto a su respectivo detalle.`;
                
                // Codificar el mensaje para URL
                const mensajeCodificado = encodeURIComponent(mensaje);
                
                // Crear URL de WhatsApp
                const whatsappUrl = `https://wa.me/${telefono}?text=${mensajeCodificado}`;
                
                // Crear un enlace temporal para descargar la imagen
                const link = document.createElement('a');
                link.download = `factura-${factura.numero}.png`;
                link.href = imageDataUrl;
                
                // Mostrar opciones al usuario
                if (confirm('¡Imagen de la factura generada! ¿Qué deseas hacer? • OK: Abrir WhatsApp y descargar imagen • Cancelar: Solo abrir WhatsApp')) {
                    // Descargar la imagen
                    link.click();
                }
                
                // Abrir WhatsApp
                window.open(whatsappUrl, '_blank');
                
                showToast('¡Listo! Imagen generada y WhatsApp abierto', 'success');
                
            } catch (error) {
                console.error('Error generando imagen:', error);
                showToast('Error al generar la imagen de la factura', 'error');
            }
        }

        async function generateFacturaImage(factura) {
            // Crear un contenedor temporal para la factura
            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.top = '-9999px';
            container.style.left = '-9999px';
            container.style.width = '800px';
            container.style.backgroundColor = 'white';
            container.style.padding = '40px';
            container.style.fontFamily = 'Arial, sans-serif';
            
            // Generar el HTML de la factura optimizado para imagen
            container.innerHTML = generateFacturaImageHTML(factura);
            
            // Agregar al DOM temporalmente
            document.body.appendChild(container);
            
            try {
                // Generar la imagen con html2canvas
                const canvas = await html2canvas(container, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Mayor calidad
                    useCORS: true,
                    logging: false,
                    width: 800,
                    height: container.scrollHeight
                });
                
                // Convertir a data URL
                const imageDataUrl = canvas.toDataURL('image/png', 0.95);
                
                return imageDataUrl;
                
            } finally {
                // Limpiar el DOM
                document.body.removeChild(container);
            }
        }

        function generateFacturaImageHTML(factura) {
            return `
                <div style="max-width: 700px; margin: 0 auto; font-family: Arial, sans-serif; color: #333; line-height: 1.6;">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px;">
                        <h1 style="font-size: 2.2em; margin-bottom: 8px; color: #333; font-weight: bold;">FACTURA</h1>
                        <div style="font-size: 1em; color: #666; line-height: 1.4;">
                            ${appData.configuracion.nombreTaller || 'Taller RUTA D'}<br>
                            ${appData.configuracion.direccion || 'Dirección del Taller'}<br>
                            Tel: ${appData.configuracion.telefono || '(000) 000-0000'} | Email: ${appData.configuracion.email || 'email@taller.com'}
                        </div>
                    </div>
                    
                    <!-- Información de la factura -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 25px; padding: 15px 0;">
                        <div style="width: 48%;">
                            <h3 style="font-size: 1.3em; margin-bottom: 12px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 6px;">Información del Cliente</h3>
                            <div style="margin-bottom: 10px; font-size: 1.1em;"><strong>Cliente:</strong> ${factura.cliente}</div>
                            <div style="margin-bottom: 10px; font-size: 1.1em;"><strong>Teléfono:</strong> ${factura.telefono || 'N/A'}</div>
                            ${factura.trabajo ? `<div style="margin-bottom: 10px; font-size: 1.1em;"><strong>Vehículo:</strong> ${factura.trabajo.vehiculo || 'N/A'}</div>` : ''}
                            ${factura.trabajo ? `<div style="margin-bottom: 10px; font-size: 1.1em;"><strong>Patente:</strong> ${factura.trabajo.placa || 'N/A'}</div>` : ''}
                        </div>
                        
                        <div style="width: 48%;">
                            <h3 style="font-size: 1.3em; margin-bottom: 12px; color: #555; border-bottom: 1px solid #eee; padding-bottom: 6px;">Detalles de la Factura</h3>
                            <div style="margin-bottom: 10px; font-size: 1.1em;"><strong>Número:</strong> ${factura.numero}</div>
                            <div style="margin-bottom: 10px; font-size: 1.1em;"><strong>Fecha:</strong> ${formatDate(factura.fecha)}</div>
                            <div style="margin-bottom: 10px; font-size: 1.1em;"><strong>Estado:</strong> ${factura.estadoPago}</div>
                            <div style="margin-bottom: 10px; font-size: 1.1em;"><strong>Medio de Pago:</strong> ${factura.medioPago || 'Efectivo'}</div>
                        </div>
                    </div>
                    
                    ${factura.trabajo && factura.trabajo.repuestos && factura.trabajo.repuestos.length > 0 ? `
                        <h3 style="font-size: 1.3em; margin: 25px 0 15px 0; color: #555; border-bottom: 1px solid #eee; padding-bottom: 6px;">Repuestos/Materiales</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <thead>
                                <tr>
                                    <th style="border: 1px solid #ddd; padding: 14px 10px; text-align: left; font-size: 1em; background: #f8f9fa; font-weight: bold; color: #555;">Descripción</th>
                                    <th style="border: 1px solid #ddd; padding: 14px 10px; text-align: right; font-size: 1em; background: #f8f9fa; font-weight: bold; color: #555;">Cantidad</th>
                                    <th style="border: 1px solid #ddd; padding: 14px 10px; text-align: right; font-size: 1em; background: #f8f9fa; font-weight: bold; color: #555;">Precio Unit.</th>
                                    <th style="border: 1px solid #ddd; padding: 14px 10px; text-align: right; font-size: 1em; background: #f8f9fa; font-weight: bold; color: #555;">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${factura.trabajo.repuestos.map(item => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 14px 10px; font-size: 1em;">${item.descripcion}</td>
                                        <td style="border: 1px solid #ddd; padding: 14px 10px; text-align: right; font-size: 1em;">${item.cantidad}</td>
                                        <td style="border: 1px solid #ddd; padding: 14px 10px; text-align: right; font-size: 1em;">$${item.precio ? item.precio.toLocaleString() : '0'}</td>
                                        <td style="border: 1px solid #ddd; padding: 14px 10px; text-align: right; font-size: 1em;">$${item.subtotalPrecio ? item.subtotalPrecio.toLocaleString() : '0'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                    
                    ${factura.trabajo && factura.trabajo.manoObra && factura.trabajo.manoObra.length > 0 ? `
                        <h3 style="font-size: 1.3em; margin: 25px 0 15px 0; color: #555; border-bottom: 1px solid #eee; padding-bottom: 6px;">Mano de Obra</h3>
                        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                            <thead>
                                <tr>
                                    <th style="border: 1px solid #ddd; padding: 14px 10px; text-align: left; font-size: 1em; background: #f8f9fa; font-weight: bold; color: #555;">Descripción</th>
                                    <th style="border: 1px solid #ddd; padding: 14px 10px; text-align: right; font-size: 1em; background: #f8f9fa; font-weight: bold; color: #555;">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${factura.trabajo.manoObra.map(item => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 14px 10px; font-size: 1em;">${item.descripcion}</td>
                                        <td style="border: 1px solid #ddd; padding: 14px 10px; text-align: right; font-size: 1em;">$${item.valor ? item.valor.toLocaleString() : '0'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : ''}
                    
                    <div style="background: #f8f9fa; padding: 25px; border-radius: 8px; margin-top: 25px; text-align: right;">
                        <div style="font-size: 1.6em; font-weight: bold; color: #2c5530; margin-top: 12px;">TOTAL: ${formatCurrency(factura.total)}</div>
                        <div style="margin-top: 12px; font-size: 1em; color: #666;">
                            ${factura.estadoPago === 'Pagado' ? '✓ PAGADO' : 'PENDIENTE DE PAGO'}
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; font-size: 0.9em; color: #999;">
                        Gracias por confiar en nosotros | ${appData.configuracion.nombreTaller || 'Taller RUTA D'}
                    </div>
                </div>
            `;
        }

        async function changeFacturaStatus(facturaId) {
            const factura = appData.facturas.find(f => f.id === facturaId);
            if (!factura) return;
            
            // Toggle between Pendiente and Pagado only
            factura.estadoPago = factura.estadoPago === 'Pagado' ? 'Pendiente' : 'Pagado';
            
            // Update in Firebase
            await updateInFirebase('facturas', factura);
            
            loadFacturas();
            showToast(`Estado actualizado a: ${factura.estadoPago}`, 'success');
        }

        async function deleteFactura(facturaId) {
            const factura = appData.facturas.find(f => f.id === facturaId);
            if (!factura) return;
            
            if (confirm(`¿Está seguro de eliminar la factura #${factura.numero} de ${factura.cliente}?`)) {
                // Remove from array
                appData.facturas = appData.facturas.filter(f => f.id !== facturaId);
                
                // Delete from Firebase
                const firebaseKey = factura.firebaseId || factura.id;
                const deleted = await deleteFromFirebase('facturas', firebaseKey);
                if (!deleted) {
                    showToast('No se pudo eliminar la factura en Firebase', 'error');
                }
                
                // Reload the table
                loadFacturas();
                
                alert('Factura eliminada exitosamente');
            }
        }

        // Style improvements
        const additionalStyles2 = `
            .text-success { color: var(--success-color); }
            .text-error { color: var(--error-color); }
            .text-warning { color: var(--warning-color); }
            
            .form-input:invalid {
                border-color: var(--error-color);
            }
            
            .form-input:valid {
                border-color: var(--success-color);
            }
            
            @media print {
                .no-print { display: none !important; }
                body { margin: 0; }
            }
            
            .loading-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            }

            /* Login Screen Styles */
            .login-screen {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            }

            .login-container {
                width: 100%;
                max-width: 400px;
                padding: 2rem;
            }

            .login-card {
                background: var(--card-bg);
                border-radius: 1rem;
                box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.04);
                overflow: hidden;
            }

            .login-header {
                text-align: center;
                padding: 3rem 2rem 2rem;
                background: var(--card-bg);
            }

            .login-logo {
                width: 80px;
                height: 80px;
                object-fit: contain;
                margin-bottom: 1rem;
                border-radius: 50%;
                box-shadow: var(--shadow);
            }

            .login-header h1 {
                font-size: 1.875rem;
                font-weight: 700;
                color: var(--text-primary);
                margin-bottom: 0.5rem;
            }

            .login-header p {
                color: var(--text-secondary);
                font-size: 0.875rem;
            }

            .login-form {
                padding: 0 2rem 3rem;
            }

            .login-form .form-group {
                margin-bottom: 1.5rem;
            }

            .login-form .form-label {
                display: block;
                font-weight: 500;
                color: var(--text-primary);
                margin-bottom: 0.5rem;
                font-size: 0.875rem;
            }

            .login-form .form-input {
                width: 100%;
                padding: 0.875rem 1rem;
                border: 2px solid var(--border-color);
                border-radius: 0.5rem;
                font-size: 1rem;
                transition: all 0.2s ease;
                background: var(--card-bg);
            }

            .login-form .form-input:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            }

            .btn-full {
                width: 100%;
                padding: 0.875rem 1rem;
                font-size: 1rem;
                font-weight: 600;
            }

            .login-error {
                margin-top: 1rem;
                padding: 0.75rem;
                background: #fef2f2;
                border: 1px solid #fecaca;
                border-radius: 0.5rem;
                color: var(--error-color);
                font-size: 0.875rem;
                text-align: center;
            }

            /* Hidden by default */
            .app-container {
                display: none;
            }

            /* Show main app when authenticated */
            .authenticated .app-container {
                display: flex;
            }

            .authenticated .login-screen {
                display: none;
            }

            /* Toast Container */
            .toast-container {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10001;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .toast {
                background: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: 0.5rem;
                padding: 1rem 1.5rem;
                box-shadow: var(--shadow-lg);
                transform: translateX(100%);
                transition: transform 0.3s ease;
                min-width: 300px;
            }

            .toast.show {
                transform: translateX(0);
            }

            .toast.success {
                border-left: 4px solid var(--success-color);
            }

            .toast.error {
                border-left: 4px solid var(--error-color);
            }

            .toast.warning {
                border-left: 4px solid var(--warning-color);
            }

            .toast.info {
                border-left: 4px solid var(--primary-color);
            }
        `;
        
        const styleSheet2 = document.createElement('style');
        styleSheet2.textContent = additionalStyles2;
        document.head.appendChild(styleSheet2);

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const mainContent = document.getElementById('mainContent');
            const isMobile = window.innerWidth <= 1024;
            if (isMobile) {
                const show = !sidebar.classList.contains('show');
                sidebar.classList.toggle('show', show);
                sidebarOverlay.classList.toggle('hidden', !show);
            } else {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
            }
        }

        function showSection(sectionName) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');

            // Update breadcrumb
            document.getElementById('breadcrumb').textContent = getSectionTitle(sectionName);

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Show selected section
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');

            currentSection = sectionName;

            // Load section data
            loadSectionData(sectionName);
        }

        function getSectionTitle(section) {
            const titles = {
                dashboard: 'Dashboard',
                presupuestos: 'Presupuestos',
                trabajos: 'Trabajos',
                gastos: 'Gastos Operativos',
                facturacion: 'Facturación',
                consultas: 'Consulta de Trabajos',
                reportes: 'Reportes y Análisis',
                configuracion: 'Configuración',
                'ventas-insumos': 'Venta de Insumos'
            };
            return titles[section] || 'Dashboard';
        }

        function loadSectionData(section) {
            switch(section) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'presupuestos':
                    loadPresupuestos();
                    break;
                case 'trabajos':
                    loadTrabajos();
                    break;
                case 'gastos':
                    loadGastos();
                    loadCategoriasFilter();
                    break;
                case 'facturacion':
                    loadFacturas();
                    break;
                case 'consultas':
                    // No initial load needed
                    break;
                case 'reportes':
                    loadReportes();
                    break;
                case 'configuracion':
                    loadConfiguracion();
                    break;
                case 'ventas-insumos':
                    loadVentasInsumos();
                    break;
            }
        }

        // Firebase Database Management
        async function loadFirebaseData() {
            try {
                const dbRef = window.firebaseRef(database);
                const snapshot = await window.firebaseGet(window.firebaseChild(dbRef, 'taller'));
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    // Load each section with fallback to empty arrays
                    appData.presupuestos = data.presupuestos ? Object.values(data.presupuestos) : [];
                    appData.trabajos = data.trabajos ? Object.values(data.trabajos) : [];
                    appData.gastos = data.gastos ? Object.values(data.gastos) : [];
                    appData.facturas = data.facturas ? Object.values(data.facturas) : [];
                    appData.clientes = data.clientes ? Object.values(data.clientes) : [];
                    appData.ventasInsumos = data.ventasInsumos ? Object.values(data.ventasInsumos) : [];
                    appData.configuracion = data.configuracion || appData.configuracion;
                    
                    showToast('Datos sincronizados desde Firebase', 'success');
                } else {
                    // Save default configuration to Firebase
                    await saveToFirebase('configuracion', appData.configuracion);
                }
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                showToast('Error al cargar datos de Firebase', 'error');
                throw error;
            }
        }

        async function saveToFirebase(collection, data, id = null) {
            try {
                let path = `taller/${collection}`;
                
                if (id) {
                    // Update existing record
                    path += `/${id}`;
                    await window.firebaseSet(window.firebaseRef(database, path), data);
                } else if (collection !== 'configuracion') {
                    // Create new record with push (auto-generated key)
                    const newRef = window.firebasePush(window.firebaseRef(database, path));
                    await window.firebaseSet(newRef, { ...data, firebaseId: newRef.key });
                    data.firebaseId = newRef.key; // Store the Firebase ID in local data
                } else {
                    // Save configuration directly
                    await window.firebaseSet(window.firebaseRef(database, path), data);
                }
                
                return true;
            } catch (error) {
                console.error('Error saving to Firebase:', error);
                showToast('Error al guardar en Firebase', 'error');
                return false;
            }
        }

        async function updateInFirebase(collection, data) {
            try {
                const firebaseId = data.firebaseId || data.id;
                const path = `taller/${collection}/${firebaseId}`;
                
                await window.firebaseSet(window.firebaseRef(database, path), data);
                return true;
            } catch (error) {
                console.error('Error updating in Firebase:', error);
                showToast('Error al actualizar en Firebase', 'error');
                return false;
            }
        }

        async function deleteFromFirebase(collection, firebaseId) {
            try {
                const path = `taller/${collection}/${firebaseId}`;
                await window.firebaseRemove(window.firebaseRef(database, path));
                return true;
            } catch (error) {
                console.error('Error deleting from Firebase:', error);
                showToast('Error al eliminar de Firebase', 'error');
                return false;
            }
        }

        async function saveAllDataToFirebase() {
            try {
                // Save all data to Firebase
                const promises = [];
                
                // Save configuration
                promises.push(saveToFirebase('configuracion', appData.configuracion));
                
                // Save each collection
                const collections = ['presupuestos', 'trabajos', 'gastos', 'facturas', 'clientes'];
                
                for (const collection of collections) {
                    if (appData[collection] && appData[collection].length > 0) {
                        // Convert array to object for Firebase
                        const dataObject = {};
                        appData[collection].forEach(item => {
                            const key = item.firebaseId || item.id || Date.now() + Math.random();
                            dataObject[key] = { ...item, firebaseId: key };
                        });
                        
                        promises.push(
                            window.firebaseSet(
                                window.firebaseRef(database, `taller/${collection}`), 
                                dataObject
                            )
                        );
                    }
                }
                
                await Promise.all(promises);
                showToast('Todos los datos guardados en Firebase', 'success');
                return true;
            } catch (error) {
                console.error('Error saving all data:', error);
                showToast('Error al guardar datos en Firebase', 'error');
                return false;
            }
        }

        async function createFirebaseBackup() {
            try {
                // Get all data from Firebase
                const dbRef = window.firebaseRef(database);
                const snapshot = await window.firebaseGet(window.firebaseChild(dbRef, 'taller'));
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `backup-firebase-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showToast('Backup de Firebase creado exitosamente', 'success');
                } else {
                    showToast('No hay datos en Firebase para respaldar', 'warning');
                }
            } catch (error) {
                console.error('Error creating Firebase backup:', error);
                showToast('Error al crear backup de Firebase', 'error');
            }
        }

        function loadLocalData() {
            // Fallback function for when Firebase is not available
            try {
                const stored = localStorage.getItem('tallerProData');
                if (stored) {
                    const parsedData = JSON.parse(stored);
                    appData = { ...appData, ...parsedData };
                }
            } catch (error) {
                console.error('Error loading local data:', error);
            }
        }

        function saveDataLocal() {
            // Fallback function for when Firebase is not available
            try {
                localStorage.setItem('tallerProData', JSON.stringify(appData));
                return true;
            } catch (error) {
                console.error('Error saving local data:', error);
                return false;
            }
        }

        // function clearAllData() {
        //     if (confirm('¿Está seguro de que desea eliminar todos los datos? Esta acción no se puede deshacer.')) {
        //         try {
        //             // Clear Firebase data
        //             window.firebaseSet(window.firebaseRef(database, 'taller'), null);
        //             
        //             // Clear local data
        //             localStorage.removeItem('tallerProData');
        //             
        //             location.reload();
        //         } catch (error) {
        //             console.error('Error clearing data:', error);
        //             showToast('Error al limpiar datos', 'error');
        //         }
        //     }
        // }

        // Venta de Insumos functionality
        function showVentaInsumoModal() {
            clearVentaInsumoForm();
            document.getElementById('ventaInsumoModal').classList.add('show');
            addVentaInsumoItem(); // Agregar al menos un item
        }

        function hideVentaInsumoModal() {
            document.getElementById('ventaInsumoModal').classList.remove('show');
        }

        function clearVentaInsumoForm() {
            document.getElementById('ventaInsumoForm').reset();
            document.getElementById('ventaInsumoFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('ventaInsumoItemsContainer').innerHTML = '';
            document.getElementById('ventaInsumoForm').removeAttribute('data-editing-id');
            document.querySelector('#ventaInsumoModal .modal-title').textContent = 'Nueva Venta de Insumos';
            updateVentaInsumoTotals();
        }

        function addVentaInsumoItem() {
            const container = document.getElementById('ventaInsumoItemsContainer');
            const itemIndex = container.children.length;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'venta-insumo-item';
            itemDiv.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Descripción *</label>
                    <input type="text" class="form-input venta-insumo-desc" required onchange="updateVentaInsumoTotals()" oninput="formatTitleCase(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">Cantidad *</label>
                    <input type="number" class="form-input venta-insumo-cant" min="1" value="1" required onchange="updateVentaInsumoTotals()">
                </div>
                <div class="form-group">
                    <label class="form-label">Costo Unit. *</label>
                    <input type="number" class="form-input venta-insumo-costo" min="0" step="0.01" required onchange="updateVentaInsumoTotals()">
                </div>
                <div class="form-group">
                    <label class="form-label">Precio Unit. *</label>
                    <input type="number" class="form-input venta-insumo-precio" min="0" step="0.01" required onchange="updateVentaInsumoTotals()">
                </div>
                <button type="button" class="item-remove-btn" onclick="removeVentaInsumoItem(this)" title="Eliminar item">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            container.appendChild(itemDiv);
            updateVentaInsumoTotals();
        }

        function removeVentaInsumoItem(button) {
            const container = document.getElementById('ventaInsumoItemsContainer');
            if (container.children.length > 1) {
                button.closest('.venta-insumo-item').remove();
                updateVentaInsumoTotals();
            } else {
                showToast('Debe mantener al menos un insumo', 'warning');
            }
        }

        function updateVentaInsumoTotals() {
            const items = document.querySelectorAll('.venta-insumo-item');
            let totalCosto = 0;
            let totalVenta = 0;
            
            items.forEach(item => {
                const cantidad = parseFloat(item.querySelector('.venta-insumo-cant').value) || 0;
                const costo = parseFloat(item.querySelector('.venta-insumo-costo').value) || 0;
                const precio = parseFloat(item.querySelector('.venta-insumo-precio').value) || 0;
                
                totalCosto += cantidad * costo;
                totalVenta += cantidad * precio;
            });
            
            const margen = totalVenta - totalCosto;
            
            document.getElementById('totalCostoVentaInsumo').textContent = formatCurrency(totalCosto);
            document.getElementById('totalVentaInsumo').textContent = formatCurrency(totalVenta);
            document.getElementById('margenVentaInsumo').textContent = formatCurrency(margen);
        }

        async function handleVentaInsumoSubmit(e) {
            e.preventDefault();
            
            const items = document.querySelectorAll('.venta-insumo-item');
            const insumos = [];
            
            items.forEach(item => {
                const descripcion = item.querySelector('.venta-insumo-desc').value;
                const cantidad = parseFloat(item.querySelector('.venta-insumo-cant').value);
                const costo = parseFloat(item.querySelector('.venta-insumo-costo').value);
                const precio = parseFloat(item.querySelector('.venta-insumo-precio').value);
                
                if (descripcion && cantidad && costo >= 0 && precio >= 0) {
                    insumos.push({
                        descripcion,
                        cantidad,
                        costo,
                        precio,
                        subtotalCosto: cantidad * costo,
                        subtotalPrecio: cantidad * precio
                    });
                }
            });
            
            if (insumos.length === 0) {
                showToast('Debe agregar al menos un insumo válido', 'error');
                return;
            }
            
            const totalCosto = insumos.reduce((sum, item) => sum + item.subtotalCosto, 0);
            const totalVenta = insumos.reduce((sum, item) => sum + item.subtotalPrecio, 0);
            const margen = totalVenta - totalCosto;
            
            const editingId = document.getElementById('ventaInsumoForm').getAttribute('data-editing-id');
            
            const ventaInsumo = {
                id: editingId || Date.now().toString(),
                numero: editingId ? appData.ventasInsumos.find(v => v.id === editingId).numero : getNextVentaInsumoNumber(),
                cliente: document.getElementById('ventaInsumoCliente').value,
                telefono: document.getElementById('ventaInsumoTelefono').value,
                fecha: document.getElementById('ventaInsumoFecha').value,
                metodoPago: document.getElementById('ventaInsumoMetodoPago').value,
                insumos: insumos,
                costoTotal: totalCosto,
                total: totalVenta,
                margen: margen
            };
            
            if (editingId) {
                // Update existing
                const index = appData.ventasInsumos.findIndex(v => v.id === editingId);
                appData.ventasInsumos[index] = ventaInsumo;
                await updateInFirebase('ventasInsumos', ventaInsumo);
                showToast('Venta actualizada exitosamente', 'success');
            } else {
                // Create new
                appData.ventasInsumos.push(ventaInsumo);
                await saveToFirebase('ventasInsumos', ventaInsumo);
                showToast('Venta guardada exitosamente', 'success');
            }
            
            hideVentaInsumoModal();
            loadVentasInsumos();
            updateDashboard();
        }

        function getNextVentaInsumoNumber() {
            const lastNumber = appData.ventasInsumos.reduce((max, v) => {
                const num = parseInt(v.numero) || 0;
                return num > max ? num : max;
            }, 0);
            return (lastNumber + 1).toString().padStart(4, '0');
        }

        function loadVentasInsumos() {
            const tbody = document.getElementById('ventasInsumosTable');
            tbody.innerHTML = '';

            appData.ventasInsumos.forEach(venta => {
                const margenPorcentaje = venta.total > 0 ? ((venta.margen / venta.total) * 100).toFixed(1) : 0;
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${venta.numero}</td>
                    <td>${venta.cliente}</td>
                    <td>${formatDate(venta.fecha)}</td>
                    <td>${formatCurrency(venta.costoTotal || 0)}</td>
                    <td>${formatCurrency(venta.total || 0)}</td>
                    <td>${formatCurrency(venta.margen || 0)} (${margenPorcentaje}%)</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewVentaInsumo('${venta.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="editVentaInsumo('${venta.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteVentaInsumo('${venta.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        function viewVentaInsumo(ventaId) {
            const venta = appData.ventasInsumos.find(v => v.id === ventaId);
            if (!venta) return;
            
            let content = `
                <div class="view-details">
                    <div class="view-header">
                        <h4>VENTA DE INSUMOS #${venta.numero}</h4>
                    </div>
                    
                    <div class="view-section">
                        <h5>Información de la Venta</h5>
                        <p><strong>Cliente:</strong> ${venta.cliente}</p>
                        <p><strong>Teléfono:</strong> ${venta.telefono || 'N/A'}</p>
                        <p><strong>Fecha:</strong> ${formatDate(venta.fecha)}</p>
                        <p><strong>Método de Pago:</strong> ${venta.metodoPago}</p>
                    </div>
                    
                    <div class="view-section">
                        <h5>Insumos/Repuestos</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Descripción</th>
                                    <th>Cantidad</th>
                                    <th>Costo Unit.</th>
                                    <th>Precio Unit.</th>
                                    <th>Subtotal Costo</th>
                                    <th>Subtotal Venta</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            venta.insumos.forEach(insumo => {
                content += `
                    <tr>
                        <td>${insumo.descripcion}</td>
                        <td>${insumo.cantidad}</td>
                        <td>${formatCurrency(insumo.costo)}</td>
                        <td>${formatCurrency(insumo.precio)}</td>
                        <td>${formatCurrency(insumo.subtotalCosto)}</td>
                        <td>${formatCurrency(insumo.subtotalPrecio)}</td>
                    </tr>
                `;
            });
            
            const margenPorcentaje = venta.total > 0 ? ((venta.margen / venta.total) * 100).toFixed(1) : 0;
            content += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="view-section">
                        <div class="view-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div>
                                <p><strong>Total Costo:</strong> ${formatCurrency(venta.costoTotal || 0)}</p>
                            </div>
                            <div>
                                <p><strong>Total Venta:</strong> ${formatCurrency(venta.total || 0)}</p>
                            </div>
                            <div>
                                <p><strong>Margen:</strong> ${formatCurrency(venta.margen || 0)} (${margenPorcentaje}%)</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('ventaInsumoViewContent').innerHTML = content;
            document.getElementById('ventaInsumoViewModal').classList.add('show');
        }

        function hideVentaInsumoViewModal() {
            document.getElementById('ventaInsumoViewModal').classList.remove('show');
        }

        function editVentaInsumo(ventaId) {
            const venta = appData.ventasInsumos.find(v => v.id === ventaId);
            if (!venta) return;
            
            clearVentaInsumoForm();
            
            document.getElementById('ventaInsumoCliente').value = venta.cliente;
            document.getElementById('ventaInsumoTelefono').value = venta.telefono || '';
            document.getElementById('ventaInsumoFecha').value = venta.fecha;
            document.getElementById('ventaInsumoMetodoPago').value = venta.metodoPago;
            
            // Cargar insumos
            venta.insumos.forEach(insumo => {
                addVentaInsumoItem();
                const lastItem = document.getElementById('ventaInsumoItemsContainer').lastElementChild;
                lastItem.querySelector('.venta-insumo-desc').value = insumo.descripcion;
                lastItem.querySelector('.venta-insumo-cant').value = insumo.cantidad;
                lastItem.querySelector('.venta-insumo-costo').value = insumo.costo;
                lastItem.querySelector('.venta-insumo-precio').value = insumo.precio;
            });
            
            updateVentaInsumoTotals();
            
            document.getElementById('ventaInsumoForm').setAttribute('data-editing-id', ventaId);
            document.querySelector('#ventaInsumoModal .modal-title').textContent = 'Editar Venta de Insumos';
            document.getElementById('ventaInsumoModal').classList.add('show');
        }

        async function deleteVentaInsumo(ventaId) {
            const venta = appData.ventasInsumos.find(v => v.id === ventaId);
            if (!venta) return;
            
            if (confirm(`¿Está seguro de eliminar la venta #${venta.numero} de ${venta.cliente}?`)) {
                appData.ventasInsumos = appData.ventasInsumos.filter(v => v.id !== ventaId);
                
                const firebaseKey = venta.firebaseId || venta.id;
                const deleted = await deleteFromFirebase('ventasInsumos', firebaseKey);
                if (!deleted) {
                    showToast('No se pudo eliminar la venta en Firebase', 'error');
                }
                
                loadVentasInsumos();
                updateDashboard();
                showToast('Venta eliminada exitosamente', 'success');
            }
        }

        // Trabajos functionality
        function showTrabajoModal() {
            document.getElementById('trabajoModal').classList.add('show');
            clearTrabajoForm();
            loadClientesForTrabajoAutocomplete();
            loadVehiculosDatalist('vehiculosList');
        }

        function hideTrabajoModal() {
            document.getElementById('trabajoModal').classList.remove('show');
        }

        function loadClientesForTrabajoAutocomplete() {
            const datalist = document.getElementById('trabajoClientesList');
            datalist.innerHTML = '';
            
            // Get unique clients from presupuestos and trabajos
            const clientesSet = new Set();
            
            // Add clients from presupuestos
            appData.presupuestos.forEach(p => {
                let clienteNombre = '';
                let clienteTelefono = '';
                
                // Handle different client data structures
                if (typeof p.cliente === 'string') {
                    clienteNombre = p.cliente;
                    clienteTelefono = p.telefono || '';
                } else if (p.cliente && p.cliente.nombre) {
                    clienteNombre = p.cliente.nombre;
                    clienteTelefono = p.cliente.telefono || p.telefono || '';
                }
                
                if (clienteNombre && clienteNombre.trim()) {
                    clientesSet.add(JSON.stringify({
                        nombre: clienteNombre,
                        telefono: clienteTelefono
                    }));
                }
            });
            
            // Add clients from trabajos
            appData.trabajos.forEach(t => {
                if (t.cliente && t.cliente.trim()) {
                    clientesSet.add(JSON.stringify({
                        nombre: t.cliente,
                        telefono: t.telefono || ''
                    }));
                }
            });
            
            // Create options for datalist
            Array.from(clientesSet).forEach(clienteStr => {
                const cliente = JSON.parse(clienteStr);
                const option = document.createElement('option');
                option.value = cliente.nombre;
                option.setAttribute('data-telefono', cliente.telefono);
                datalist.appendChild(option);
            });
        }

        function handleTrabajoClienteInput() {
            // This function is called on every keystroke
            // We can use it for real-time filtering if needed
        }

        function handleTrabajoClienteChange() {
            const clienteInput = document.getElementById('trabajoCliente');
            const telefonoInput = document.getElementById('trabajoTelefono');
            const datalist = document.getElementById('trabajoClientesList');
            
            // Find the selected option
            const selectedOption = Array.from(datalist.options).find(option => 
                option.value === clienteInput.value
            );
            
            if (selectedOption) {
                // Auto-fill telefono if option was selected
                const telefono = selectedOption.getAttribute('data-telefono');
                if (telefono && telefono.trim()) {
                    telefonoInput.value = telefono;
                }
            }
        }

        function showTrabajoFromPresupuesto() {
            loadPresupuestosForSelection();
            document.getElementById('presupuestoSelectModal').classList.add('show');
        }

        function hidePresupuestoSelectModal() {
            document.getElementById('presupuestoSelectModal').classList.remove('show');
        }

        function loadPresupuestosForSelection() {
            const tbody = document.getElementById('presupuestosSelectTable');
            tbody.innerHTML = '';
            
            // Filter presupuestos that are approved and not already converted to trabajos
            const presupuestosDisponibles = appData.presupuestos.filter(p => 
                p.estado === 'Aprobado' || p.estado === 'Pendiente'
            );
            
            if (presupuestosDisponibles.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="6" style="text-align: center;">No hay presupuestos disponibles para convertir</td>';
                return;
            }
            
            presupuestosDisponibles.forEach(presupuesto => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${presupuesto.numero}</td>
                    <td>${presupuesto.cliente.nombre}</td>
                    <td>${presupuesto.vehiculo}</td>
                    <td>${formatCurrency(presupuesto.total)}</td>
                    <td><span class="badge badge-${getStatusClass(presupuesto.estado)}">${presupuesto.estado}</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="convertirPresupuestoATrabajo('${presupuesto.id}')">
                            <i class="fas fa-arrow-right"></i>
                            Convertir
                        </button>
                    </td>
                `;
            });
        }

        async function convertirPresupuestoATrabajo(presupuestoId) {
            const presupuesto = appData.presupuestos.find(p => p.id === presupuestoId);
            if (!presupuesto) return;
            
            // Clear trabajo form first
            clearTrabajoForm();
            
            // Pre-fill trabajo form with presupuesto data
            document.getElementById('trabajoCliente').value = presupuesto.cliente.nombre;
            document.getElementById('trabajoTelefono').value = presupuesto.cliente.telefono || '';
            document.getElementById('trabajoVehiculo').value = presupuesto.vehiculo;
            document.getElementById('trabajoPlaca').value = presupuesto.placa || '';
            document.getElementById('trabajoDiagnostico').value = presupuesto.diagnostico || '';
            
            // Add repuestos
            if (presupuesto.repuestos && presupuesto.repuestos.length > 0) {
                presupuesto.repuestos.forEach(repuesto => {
                    addTrabajoRepuesto();
                    const lastRow = document.getElementById('trabajoRepuestosContainer').lastElementChild;
                    lastRow.querySelector('.trabajo-repuesto-desc').value = repuesto.descripcion;
                    lastRow.querySelector('.trabajo-repuesto-cant').value = repuesto.cantidad;
                    lastRow.querySelector('.trabajo-repuesto-precio').value = repuesto.precio;
                });
            }
            
            // Add mano de obra
            if (presupuesto.manoObra && presupuesto.manoObra.length > 0) {
                presupuesto.manoObra.forEach(trabajo => {
                    addTrabajoManoObra();
                    const lastRow = document.getElementById('trabajoManoObraContainer').lastElementChild;
                    lastRow.querySelector('.trabajo-trabajo-desc').value = trabajo.descripcion;
                    lastRow.querySelector('.trabajo-trabajo-valor').value = trabajo.valor;
                });
            }
            
            updateTrabajoCostos();
            hidePresupuestoSelectModal();
            
            // Store presupuesto ID to delete after trabajo is saved
            sessionStorage.setItem('presupuestoToDelete', presupuestoId);
            
            // Show modal without clearing the form
            document.getElementById('trabajoModal').classList.add('show');
        }

        function clearTrabajoForm() {
            document.getElementById('trabajoForm').reset();
            document.getElementById('trabajoRepuestosContainer').innerHTML = '';
            document.getElementById('trabajoManoObraContainer').innerHTML = '';
            document.getElementById('trabajoFechaIngreso').value = new Date().toISOString().split('T')[0];
            document.querySelector('#trabajoModal .modal-title').textContent = 'Nuevo Trabajo';
            delete document.getElementById('trabajoForm').dataset.editingId;
            updateTrabajoCostos();
        }

        function addTrabajoRepuesto() {
            const container = document.getElementById('trabajoRepuestosContainer');
            
            const row = document.createElement('div');
            row.className = 'form-grid-2';
            row.style.border = '1px solid var(--border-color)';
            row.style.padding = '1rem';
            row.style.borderRadius = '0.5rem';
            row.style.marginBottom = '1rem';
            
            row.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <input type="text" class="form-input trabajo-repuesto-desc" required oninput="formatTitleCase(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">Cantidad</label>
                    <input type="number" class="form-input trabajo-repuesto-cant" min="0.01" step="0.01" value="1" onchange="updateTrabajoCostos()">
                </div>
                <div class="form-group">
                    <label class="form-label">Costo Unitario</label>
                    <input type="number" class="form-input trabajo-repuesto-costo" min="0" step="1" onchange="updateTrabajoCostos()">
                </div>
                <div class="form-group">
                    <label class="form-label">Precio Venta</label>
                    <input type="number" class="form-input trabajo-repuesto-precio" min="0" step="1" onchange="updateTrabajoCostos()">
                </div>
                <div class="form-group" style="display: flex; align-items: end; grid-column: span 2;">
                    <button type="button" class="btn btn-danger" onclick="this.parentElement.parentElement.remove(); updateTrabajoCostos();">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(row);
        }

        function addTrabajoManoObra() {
            const container = document.getElementById('trabajoManoObraContainer');
            
            const row = document.createElement('div');
            row.className = 'form-grid-2';
            row.style.border = '1px solid var(--border-color)';
            row.style.padding = '1rem';
            row.style.borderRadius = '0.5rem';
            row.style.marginBottom = '1rem';
            
            row.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <input type="text" class="form-input trabajo-trabajo-desc" required oninput="formatTitleCase(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">Valor</label>
                    <input type="number" class="form-input trabajo-trabajo-valor" min="0" step="1" onchange="updateTrabajoCostos()">
                </div>
                <div class="form-group" style="display: flex; align-items: end; grid-column: span 2;">
                    <button type="button" class="btn btn-danger" onclick="this.parentElement.parentElement.remove(); updateTrabajoCostos();">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(row);
        }

        function updateTrabajoCostos() {
            let costoTotal = 0;
            let precioTotal = 0;

            // Calculate repuestos
            document.querySelectorAll('#trabajoRepuestosContainer .form-grid, #trabajoRepuestosContainer .form-grid-2').forEach(row => {
                const cantidad = parseFloat(row.querySelector('.trabajo-repuesto-cant').value) || 0;
                const costo = parseFloat(row.querySelector('.trabajo-repuesto-costo').value) || 0;
                const precio = parseFloat(row.querySelector('.trabajo-repuesto-precio').value) || 0;
                
                costoTotal += cantidad * costo;
                precioTotal += cantidad * precio;
            });

            // Calculate mano de obra
            document.querySelectorAll('#trabajoManoObraContainer .form-grid, #trabajoManoObraContainer .form-grid-2').forEach(row => {
                const valor = parseFloat(row.querySelector('.trabajo-trabajo-valor').value) || 0;
                
                precioTotal += valor; // Direct value without hours multiplication
            });

            const margen = precioTotal - costoTotal;
            const margenPorcentaje = precioTotal > 0 ? ((margen / precioTotal) * 100).toFixed(1) : 0;

            document.getElementById('costoInsumos').textContent = formatCurrency(costoTotal);
            document.getElementById('precioVenta').textContent = formatCurrency(precioTotal);
            document.getElementById('margenGanancia').textContent = `${formatCurrency(margen)} (${margenPorcentaje}%)`;
        }

        async function handleTrabajoSubmit(e) {
            e.preventDefault();
            
            const editingId = e.target.dataset.editingId;
            
            const trabajoData = {
                cliente: document.getElementById('trabajoCliente').value,
                telefono: document.getElementById('trabajoTelefono').value,
                vehiculo: document.getElementById('trabajoVehiculo').value,
                placa: document.getElementById('trabajoPlaca').value,
                fechaIngreso: document.getElementById('trabajoFechaIngreso').value,
                diagnostico: document.getElementById('trabajoDiagnostico').value,
                estado: document.getElementById('trabajoEstado').value,
                repuestos: collectTrabajoRepuestos(),
                manoObra: collectTrabajoManoObra(),
                costoTotal: calculateCostoTotal(),
                total: calculatePrecioTotal(),
                margen: calculateMargen()
            };

            // Guardar vehículo en caché
            saveVehiculoToCache(trabajoData.vehiculo);

            if (editingId) {
                // Update existing trabajo
                const index = appData.trabajos.findIndex(t => t.id === editingId);
                if (index !== -1) {
                    appData.trabajos[index] = { 
                        ...appData.trabajos[index], 
                        ...trabajoData,
                        fechaModificacion: new Date().toISOString().split('T')[0]
                    };
                    
                    // Update in Firebase
                    await updateInFirebase('trabajos', appData.trabajos[index]);
                    
                    showToast('Trabajo actualizado correctamente', 'success');
                }
                delete e.target.dataset.editingId;
            } else {
                // Create new trabajo
                const trabajo = {
                    id: Date.now().toString(),
                    numero: getNextTrabajoNumber(),
                    fecha: new Date().toISOString().split('T')[0],
                    ...trabajoData
                };
                appData.trabajos.push(trabajo);
                
                // Save to Firebase
                await saveToFirebase('trabajos', trabajo);
                
                // Check if this trabajo was created from a presupuesto conversion
                const presupuestoToDelete = sessionStorage.getItem('presupuestoToDelete');
                if (presupuestoToDelete) {
                    // Find and delete the presupuesto
                    const presupuesto = appData.presupuestos.find(p => p.id === presupuestoToDelete);
                    if (presupuesto) {
                        // Remove from local data
                        appData.presupuestos = appData.presupuestos.filter(p => p.id !== presupuestoToDelete);
                        
                        // Remove from Firebase
                        if (presupuesto.firebaseId) {
                            await deleteFromFirebase('presupuestos', presupuesto.firebaseId);
                        }
                        
                        showToast('Presupuesto convertido a trabajo y eliminado', 'success');
                        loadPresupuestos(); // Refresh presupuestos list
                    }
                    
                    // Clear the session storage
                    sessionStorage.removeItem('presupuestoToDelete');
                } else {
                    showToast('Trabajo guardado correctamente', 'success');
                }
            }

            hideTrabajoModal();
            loadTrabajos();
            updateDashboard();
        }

        function collectTrabajoRepuestos() {
            const repuestos = [];
            document.querySelectorAll('#trabajoRepuestosContainer .form-grid, #trabajoRepuestosContainer .form-grid-2').forEach(row => {
                const desc = row.querySelector('.trabajo-repuesto-desc').value;
                const cant = parseFloat(row.querySelector('.trabajo-repuesto-cant').value) || 0;
                const costo = parseFloat(row.querySelector('.trabajo-repuesto-costo').value) || 0;
                const precio = parseFloat(row.querySelector('.trabajo-repuesto-precio').value) || 0;
                
                if (desc && cant && (costo || precio)) {
                    repuestos.push({
                        descripcion: desc,
                        cantidad: cant,
                        costo: costo,
                        precio: precio,
                        subtotalCosto: cant * costo,
                        subtotalPrecio: cant * precio
                    });
                }
            });
            return repuestos;
        }

        function collectTrabajoManoObra() {
            const trabajos = [];
            document.querySelectorAll('#trabajoManoObraContainer .form-grid, #trabajoManoObraContainer .form-grid-2').forEach(row => {
                const desc = row.querySelector('.trabajo-trabajo-desc').value;
                const valor = parseFloat(row.querySelector('.trabajo-trabajo-valor').value) || 0;
                
                if (desc && valor) {
                    trabajos.push({
                        descripcion: desc,
                        valor: valor,
                        subtotal: valor // Direct value without hours multiplication
                    });
                }
            });
            return trabajos;
        }

        function calculateCostoTotal() {
            let total = 0;
            document.querySelectorAll('#trabajoRepuestosContainer .form-grid, #trabajoRepuestosContainer .form-grid-2').forEach(row => {
                const cantidad = parseFloat(row.querySelector('.trabajo-repuesto-cant').value) || 0;
                const costo = parseFloat(row.querySelector('.trabajo-repuesto-costo').value) || 0;
                total += cantidad * costo;
            });
            return total;
        }

        function calculatePrecioTotal() {
            let total = 0;
            document.querySelectorAll('#trabajoRepuestosContainer .form-grid, #trabajoRepuestosContainer .form-grid-2').forEach(row => {
                const cantidad = parseFloat(row.querySelector('.trabajo-repuesto-cant').value) || 0;
                const precio = parseFloat(row.querySelector('.trabajo-repuesto-precio').value) || 0;
                total += cantidad * precio;
            });
            document.querySelectorAll('#trabajoManoObraContainer .form-grid, #trabajoManoObraContainer .form-grid-2').forEach(row => {
                const valor = parseFloat(row.querySelector('.trabajo-trabajo-valor').value) || 0;
                total += valor;
            });
            return total;
        }

        function calculateMargen() {
            return calculatePrecioTotal() - calculateCostoTotal();
        }

        function getNextTrabajoNumber() {
            const lastNumber = appData.trabajos.reduce((max, t) => {
                const num = parseInt(t.numero) || 0;
                return num > max ? num : max;
            }, 0);
            return (lastNumber + 1).toString().padStart(4, '0');
        }

        function loadTrabajos() {
            const tbody = document.getElementById('trabajosTable');
            tbody.innerHTML = '';

            appData.trabajos.forEach(trabajo => {
                const margenPorcentaje = trabajo.total > 0 ? ((trabajo.margen / trabajo.total) * 100).toFixed(1) : 0;
                const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${trabajo.numero}</td>
                        <td>${trabajo.cliente}</td>
                        <td>${trabajo.vehiculo}</td>
                        <td><span class="badge badge-${getStatusClass(trabajo.estado)}">${trabajo.estado}</span></td>
                        <td>${formatCurrency(trabajo.total)}</td>
                        <td>${formatCurrency(trabajo.margen)} (${margenPorcentaje}%)</td>
                        <td>${formatDate(trabajo.fechaIngreso)}</td>
                        <td class="text-right">
                            <div class="btn-group-right">
                                <button class="btn btn-sm btn-primary" onclick="viewTrabajo('${trabajo.id}')" title="Ver Trabajo">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="editTrabajo('${trabajo.id}')" title="Editar Trabajo">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-purple" onclick="cambiarEstadoTrabajo('${trabajo.id}')" title="Cambiar Estado">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                                <button class="btn btn-sm btn-success" onclick="crearFacturaFromTrabajo('${trabajo.id}')" title="Facturar Trabajo">
                                    <i class="fas fa-file-invoice"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteTrabajo('${trabajo.id}')" title="Eliminar Trabajo">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
            });
        }

        // Gastos functionality
        function showGastoModal() {
            loadCategoriasInSelect();
            document.getElementById('gastoModal').classList.add('show');
            clearGastoForm();
        }

                // Cambiar estado del trabajo
                function cambiarEstadoTrabajo(trabajoId) {
                    const estados = ['En Proceso', 'Completado']; // Removido 'Pendiente'
                    const trabajo = appData.trabajos.find(t => t.id === trabajoId);
                    if (!trabajo) return;
                    let idx = estados.indexOf(trabajo.estado);
                    idx = (idx + 1) % estados.length;
                    trabajo.estado = estados[idx];
                    // Actualizar en Firebase si corresponde
                    if (trabajo.firebaseId) {
                        updateInFirebase('trabajos', trabajo);
                    }
                    loadTrabajos();
                    showToast('Estado actualizado a ' + trabajo.estado, 'info');
                }

        function hideGastoModal() {
            document.getElementById('gastoModal').classList.remove('show');
        }

        function clearGastoForm() {
            document.getElementById('gastoForm').reset();
            document.getElementById('gastoFecha').value = new Date().toISOString().split('T')[0];
        }

        function loadCategoriasInSelect() {
            const select = document.getElementById('gastoCategoria');
            select.innerHTML = '<option value="">Seleccionar categoría</option>';
            
            appData.configuracion.categorias.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria;
                option.textContent = categoria;
                select.appendChild(option);
            });
        }

        function loadCategoriasFilter() {
            const select = document.getElementById('filtroCategoria');
            select.innerHTML = '<option value="">Todas las categorías</option>';
            
            appData.configuracion.categorias.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria;
                option.textContent = categoria;
                select.appendChild(option);
            });
            
            // Set current month
            const now = new Date();
            document.getElementById('filtroMes').value = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
        }

        async function handleGastoSubmit(e) {
            e.preventDefault();
            
            const editingId = e.target.dataset.editingId;
            
            const gastoData = {
                fecha: document.getElementById('gastoFecha').value,
                categoria: document.getElementById('gastoCategoria').value,
                descripcion: document.getElementById('gastoDescripcion').value,
                monto: parseFloat(document.getElementById('gastoMonto').value),
                recurrente: document.getElementById('gastoRecurrente').checked
            };

            if (editingId) {
                // Update existing gasto
                const index = appData.gastos.findIndex(g => g.id === editingId);
                if (index !== -1) {
                    appData.gastos[index] = { ...appData.gastos[index], ...gastoData };
                    
                    // Update in Firebase
                    await updateInFirebase('gastos', appData.gastos[index]);
                    
                    showToast('Gasto actualizado correctamente', 'success');
                }
                delete e.target.dataset.editingId;
            } else {
                // Create new gasto
                const gasto = {
                    id: Date.now().toString(),
                    ...gastoData
                };
                
                await saveGasto(gasto);
                
                // If recurrent, create next month's entry
                if (gasto.recurrente) {
                    await createRecurrentGasto(gasto);
                }
            }
            
            hideGastoModal();
            loadGastos();
        }

        async function saveGasto(gasto) {
            appData.gastos.push(gasto);
            
            // Save to Firebase
            await saveToFirebase('gastos', gasto);
            
            showToast('Gasto guardado correctamente', 'success');
        }

        async function createRecurrentGasto(gastoOriginal) {
            const nextMonth = new Date(gastoOriginal.fecha);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            
            const gastoRecurrente = {
                ...gastoOriginal,
                id: Date.now().toString() + '_rec',
                fecha: nextMonth.toISOString().split('T')[0]
            };
            
            await saveGasto(gastoRecurrente);
        }

        function loadGastos() {
            const tbody = document.getElementById('gastosTable');
            tbody.innerHTML = '';
            
            const categoriaFilter = document.getElementById('filtroCategoria').value;
            const mesFilter = document.getElementById('filtroMes').value;
            
            let gastosFiltered = appData.gastos;
            
            if (categoriaFilter) {
                gastosFiltered = gastosFiltered.filter(g => g.categoria === categoriaFilter);
            }
            
            if (mesFilter) {
                const [year, month] = mesFilter.split('-');
                gastosFiltered = gastosFiltered.filter(g => {
                    const gastoDate = new Date(g.fecha);
                    return gastoDate.getFullYear() == year && (gastoDate.getMonth() + 1) == month;
                });
            }
            
            gastosFiltered.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            gastosFiltered.forEach(gasto => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(gasto.fecha)}</td>
                    <td>${gasto.categoria}</td>
                    <td>${gasto.descripcion}</td>
                    <td>${formatCurrency(gasto.monto)}</td>
                    <td>${gasto.recurrente ? '<i class="fas fa-check text-success"></i>' : ''}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editGasto('${gasto.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteGasto('${gasto.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        async function deleteGasto(gastoId) {
            if (confirm('¿Está seguro de que desea eliminar este gasto?')) {
                // Find gasto to get Firebase ID
                const gasto = appData.gastos.find(g => g.id === gastoId);
                
                // Remove from local data
                appData.gastos = appData.gastos.filter(g => g.id !== gastoId);
                
                // Remove from Firebase
                if (gasto && gasto.firebaseId) {
                    await deleteFromFirebase('gastos', gasto.firebaseId);
                }
                
                loadGastos();
                showToast('Gasto eliminado', 'success');
            }
        }

        // Facturación functionality
        function showFacturaModal() {
            loadTrabajosForFactura();
            document.getElementById('facturaModal').classList.add('show');
            clearFacturaForm();
        }

        function hideFacturaModal() {
            document.getElementById('facturaModal').classList.remove('show');
        }

        function clearFacturaForm() {
            document.getElementById('facturaForm').reset();
            document.getElementById('facturaFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('facturaDetalles').innerHTML = '';
        }

        function loadTrabajosForFactura() {
            const select = document.getElementById('facturaTrabajoId');
            select.innerHTML = '<option value="">Seleccionar trabajo completado</option>';
            
            const trabajosCompletados = appData.trabajos.filter(t => t.estado === 'Completado');
            trabajosCompletados.forEach(trabajo => {
                const option = document.createElement('option');
                option.value = trabajo.id;
                option.textContent = `${trabajo.numero} - ${trabajo.cliente} - ${trabajo.vehiculo}`;
                select.appendChild(option);
            });
        }

        function loadTrabajoForFactura() {
            const trabajoId = document.getElementById('facturaTrabajoId').value;
            if (!trabajoId) {
                document.getElementById('facturaCliente').value = '';
                document.getElementById('facturaDetalles').innerHTML = '';
                return;
            }
            
            const trabajo = appData.trabajos.find(t => t.id === trabajoId);
            if (!trabajo) return;
            
            document.getElementById('facturaCliente').value = trabajo.cliente;
            
            // Generate invoice details
            let detallesHtml = '<div class="card"><div class="card-header"><h4>Detalles de la Factura</h4></div><div class="card-body">';
            
            if (trabajo.repuestos && trabajo.repuestos.length > 0) {
                detallesHtml += '<h5>Repuestos</h5><div class="table-container"><table class="table"><thead><tr><th>Descripción</th><th>Cantidad</th><th>Precio Unit.</th><th>Subtotal</th></tr></thead><tbody>';
                trabajo.repuestos.forEach(repuesto => {
                    detallesHtml += `<tr><td>${repuesto.descripcion}</td><td>${repuesto.cantidad}</td><td>${formatCurrency(repuesto.precio)}</td><td>${formatCurrency(repuesto.subtotalPrecio)}</td></tr>`;
                });
                detallesHtml += '</tbody></table></div>';
            }
            
            if (trabajo.manoObra && trabajo.manoObra.length > 0) {
                detallesHtml += '<h5>Mano de Obra</h5><div class="table-container"><table class="table"><thead><tr><th>Descripción</th><th>Valor</th></tr></thead><tbody>';
                trabajo.manoObra.forEach(mano => {
                    detallesHtml += `<tr><td>${mano.descripcion}</td><td>${formatCurrency(mano.valor)}</td></tr>`;
                });
                detallesHtml += '</tbody></table></div>';
            }
            
            detallesHtml += `<div style="text-align: right; margin-top: 1rem;"><strong>Total: ${formatCurrency(trabajo.total)}</strong></div>`;
            detallesHtml += '</div></div>';
            
            document.getElementById('facturaDetalles').innerHTML = detallesHtml;
        }

        async function crearFacturaFromTrabajo(trabajoId) {
            const trabajo = appData.trabajos.find(t => t.id === trabajoId);
            if (!trabajo) {
                alert('Trabajo no encontrado');
                return;
            }
            
            // Si el trabajo no está completado, marcarlo como completado automáticamente
            if (trabajo.estado !== 'Completado') {
                trabajo.estado = 'Completado';
                
                // Actualizar en Firebase si tiene firebaseId
                if (trabajo.firebaseId) {
                    await updateInFirebase('trabajos', trabajo);
                }
                
                // Recargar la tabla para mostrar el estado actualizado
                loadTrabajos();
                showToast('Trabajo marcado como completado automáticamente', 'info');
            }
            
            // Show modal and clear form first
            clearFacturaForm();
            document.getElementById('facturaModal').classList.add('show');
            
            // Load trabajos for the dropdown and then set the specific trabajo
            loadTrabajosForFactura();
            
            // Set the specific trabajo after a short delay to ensure dropdown is populated
            setTimeout(() => {
                document.getElementById('facturaTrabajoId').value = trabajoId;
                loadTrabajoForFactura();
            }, 100);
        }

        async function handleFacturaSubmit(e) {
            e.preventDefault();
            
            const trabajoId = document.getElementById('facturaTrabajoId').value;
            const trabajo = trabajoId ? appData.trabajos.find(t => t.id === trabajoId) : null;
            
            const factura = {
                id: Date.now().toString(),
                numero: getNextFacturaNumber(),
                trabajoId: trabajoId,
                cliente: document.getElementById('facturaCliente').value,
                telefono: trabajo ? trabajo.telefono : '', // Incluir teléfono del trabajo
                fecha: document.getElementById('facturaFecha').value,
                total: trabajo ? trabajo.total : 0,
                estadoPago: 'Pendiente',
                trabajo: trabajo, // Incluir objeto trabajo completo
                detalles: trabajo ? {
                    repuestos: trabajo.repuestos,
                    manoObra: trabajo.manoObra
                } : {}
            };

            await saveFactura(factura);
            
            // Update trabajo status if applicable
            if (trabajo) {
                trabajo.estado = 'Facturado';
                await updateInFirebase('trabajos', trabajo);
            }
            
            hideFacturaModal();
            loadFacturas();
        }

        async function saveFactura(factura) {
            appData.facturas.push(factura);
            
            // Save to Firebase
            await saveToFirebase('facturas', factura);
            
            showToast('Factura generada correctamente', 'success');
        }

        function getNextFacturaNumber() {
            const lastNumber = appData.facturas.reduce((max, f) => {
                const num = parseInt(f.numero) || 0;
                return num > max ? num : max;
            }, 0);
            return (lastNumber + 1).toString().padStart(4, '0');
        }

        function loadFacturas() {
            const tbody = document.getElementById('facturasTable');
            tbody.innerHTML = '';

            appData.facturas.forEach(factura => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${factura.numero}</td>
                    <td>${factura.cliente}</td>
                    <td>${formatCurrency(factura.total)}</td>
                    <td><span class="badge badge-${getStatusClass(factura.estadoPago)}">${factura.estadoPago}</span></td>
                       <td>${factura.medioPago || 'Efectivo'}</td>
                    <td>${formatDate(factura.fecha)}</td>
                    <td>
                            <button class="btn btn-sm btn-success" onclick="printFactura('${factura.id}')" title="Imprimir factura">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-sm btn-info" onclick="shareFacturaWhatsApp('${factura.id}')" title="Compartir por WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="changeFacturaStatus('${factura.id}')" title="Cambiar estado de pago">
                                <i class="fas fa-credit-card"></i>
                            </button>
                            <button class="btn btn-sm btn-purple" onclick="changeMedioPago('${factura.id}')" title="Cambiar medio de pago">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteFactura('${factura.id}')" title="Eliminar factura">
                                <i class="fas fa-trash"></i>
                            </button>
                    </td>
                `;
            });
        }

            // Cambia el medio de pago y actualiza en Firebase
            window.changeMedioPago = async function(facturaId) {
                const factura = appData.facturas.find(f => f.id === facturaId);
                if (!factura) return;
                const medios = ['Efectivo', 'MercadoPago', 'Otro'];
                let idx = medios.indexOf(factura.medioPago);
                idx = (idx + 1) % medios.length;
                factura.medioPago = medios[idx];
                await updateInFirebase('facturas', factura);
                loadFacturas();
                showToast(`Medio de pago: ${factura.medioPago}`, 'info');
            }

        // Consultas functionality
        function realizarConsulta() {
            const cliente = document.getElementById('consultaCliente').value.toLowerCase();
            const fechaDesde = document.getElementById('consultaFechaDesde').value;
            const fechaHasta = document.getElementById('consultaFechaHasta').value;

            let filteredData = appData.trabajos;

            // Filter by cliente
            if (cliente) {
                filteredData = filteredData.filter(item => {
                    const clienteField = item.cliente?.nombre || item.cliente || '';
                    return clienteField.toLowerCase().includes(cliente);
                });
            }

            // Filter by date range
            if (fechaDesde) {
                filteredData = filteredData.filter(item => {
                    const itemDate = new Date(item.fechaIngreso || item.fecha);
                    return itemDate >= new Date(fechaDesde);
                });
            }

            if (fechaHasta) {
                filteredData = filteredData.filter(item => {
                    const itemDate = new Date(item.fechaIngreso || item.fecha);
                    return itemDate <= new Date(fechaHasta);
                });
            }

            displayConsultaResults(filteredData, 'trabajos');
        }

        function displayConsultaResults(data, tipo) {
            const container = document.getElementById('consultaResultados');
            
            if (data.length === 0) {
                container.innerHTML = '<p>No se encontraron resultados.</p>';
                return;
            }

            let html = '<div class="table-container"><table class="table"><thead><tr>';
            
            // Dynamic headers based on type
            switch(tipo) {
                case 'presupuestos':
                    html += '<th>Nº</th><th>Cliente</th><th>Vehículo</th><th>Total</th><th>Estado</th><th>Fecha</th>';
                    break;
                case 'trabajos':
                    html += '<th>Nº</th><th>Cliente</th><th>Vehículo</th><th>Estado</th><th>Total</th><th>Margen</th><th>Fecha</th>';
                    break;
                case 'facturas':
                    html += '<th>Nº</th><th>Cliente</th><th>Total</th><th>Estado Pago</th><th>Fecha</th>';
                    break;
                case 'gastos':
                    html += '<th>Fecha</th><th>Categoría</th><th>Descripción</th><th>Monto</th>';
                    break;
            }
            
            html += '</tr></thead><tbody>';
            
            data.forEach(item => {
                html += '<tr>';
                switch(tipo) {
                    case 'presupuestos':
                        html += `<td>${item.numero}</td><td>${item.cliente.nombre}</td><td>${item.vehiculo}</td><td>${formatCurrency(item.total)}</td><td><span class="badge badge-${getStatusClass(item.estado)}">${item.estado}</span></td><td>${formatDate(item.fecha)}</td>`;
                        break;
                    case 'trabajos':
                        const margenPorcentaje = item.total > 0 ? ((item.margen / item.total) * 100).toFixed(1) : 0;
                        html += `<td>${item.numero}</td><td>${item.cliente}</td><td>${item.vehiculo}</td><td><span class="badge badge-${getStatusClass(item.estado)}">${item.estado}</span></td><td>${formatCurrency(item.total)}</td><td>${formatCurrency(item.margen)} (${margenPorcentaje}%)</td><td>${formatDate(item.fecha)}</td>`;
                        break;
                    case 'facturas':
                        html += `<td>${item.numero}</td><td>${item.cliente}</td><td>${formatCurrency(item.total)}</td><td><span class="badge badge-${getStatusClass(item.estadoPago)}">${item.estadoPago}</span></td><td>${formatDate(item.fecha)}</td>`;
                        break;
                    case 'gastos':
                        html += `<td>${formatDate(item.fecha)}</td><td>${item.categoria}</td><td>${item.descripcion}</td><td>${formatCurrency(item.monto)}</td>`;
                        break;
                }
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }


        function loadConfiguracion() {
            document.getElementById('confNombreTaller').value = appData.configuracion.nombreTaller;
            document.getElementById('confDireccion').value = appData.configuracion.direccion || '';
            document.getElementById('confTelefono').value = appData.configuracion.telefono || '';
            document.getElementById('confEmail').value = appData.configuracion.email || '';
            // IVA field removed
        }

        async function handleConfiguracionSubmit(e) {
            e.preventDefault();
            
            appData.configuracion = {
                ...appData.configuracion,
                nombreTaller: document.getElementById('confNombreTaller').value,
                direccion: document.getElementById('confDireccion').value,
                telefono: document.getElementById('confTelefono').value,
                email: document.getElementById('confEmail').value
            };

            // Save configuration to Firebase
            await saveToFirebase('configuracion', appData.configuracion);
            
            showToast('Configuración guardada correctamente', 'success');
        }

        function loadReportes() {
            populateMonthSelector();
            generateResumenFinanciero();
            generateGastosPorCategoria();
            generateEvolucionMensual();
            generateEvolucionSemanal();
        }

        function populateMonthSelector() {
            const selector = document.getElementById('selectorMes');
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            selector.innerHTML = '';
            
            // Generate options for current year and previous year
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            for (let year = currentYear; year >= currentYear - 1; year--) {
                for (let month = 11; month >= 0; month--) {
                    if (year === currentYear && month > currentMonth) continue; // Skip future months
                    
                    const option = document.createElement('option');
                    option.value = `${year}-${month}`;
                    option.textContent = `${meses[month]} ${year}`;
                    
                    if (year === currentYear && month === currentMonth) {
                        option.selected = true;
                    }
                    
                    selector.appendChild(option);
                }
            }
        }

        function updateReportesByMonth() {
            generateResumenFinanciero();
            generateGastosPorCategoria();
        }

        function resetToCurrentMonth() {
            const currentDate = new Date();
            const selector = document.getElementById('selectorMes');
            selector.value = `${currentDate.getFullYear()}-${currentDate.getMonth()}`;
            updateReportesByMonth();
        }

        function getSelectedMonthYear() {
            const selector = document.getElementById('selectorMes');
            if (!selector.value) {
                const currentDate = new Date();
                return { month: currentDate.getMonth(), year: currentDate.getFullYear() };
            }
            
            const [year, month] = selector.value.split('-');
            return { month: parseInt(month), year: parseInt(year) };
        }

        function generateResumenFinanciero() {
            // Usar mes seleccionado en lugar del mes actual
            const selectedDate = getSelectedMonthYear();
            const currentMonth = selectedDate.month;
            const currentYear = selectedDate.year;
            
            const ingresosTrabajo = appData.trabajos
                .filter(trabajo => {
                    const fecha = new Date(trabajo.fecha);
                    return fecha.getMonth() === currentMonth && fecha.getFullYear() === currentYear;
                })
                .reduce((total, trabajo) => total + (trabajo.total || 0), 0);
                
            const ingresosVentaInsumos = appData.ventasInsumos
                .filter(venta => {
                    const fecha = new Date(venta.fecha);
                    return fecha.getMonth() === currentMonth && fecha.getFullYear() === currentYear;
                })
                .reduce((total, venta) => total + parseFloat(venta.total || 0), 0);

            const ingresosMes = ingresosTrabajo + ingresosVentaInsumos;

            const margenTrabajo = appData.trabajos
                .filter(trabajo => {
                    const fecha = new Date(trabajo.fecha);
                    return fecha.getMonth() === currentMonth && fecha.getFullYear() === currentYear;
                })
                .reduce((total, trabajo) => total + (trabajo.margen || 0), 0);
                
            const margenVentaInsumos = appData.ventasInsumos
                .filter(venta => {
                    const fecha = new Date(venta.fecha);
                    return fecha.getMonth() === currentMonth && fecha.getFullYear() === currentYear;
                })
                .reduce((total, venta) => {
                    const costo = parseFloat(venta.costoTotal || 0);
                    const precio = parseFloat(venta.total || 0);
                    return total + (precio - costo);
                }, 0);

            const margenMes = margenTrabajo + margenVentaInsumos;

            const gastosMes = appData.gastos
                .filter(gasto => {
                    const fecha = new Date(gasto.fecha);
                    return fecha.getMonth() === currentMonth && fecha.getFullYear() === currentYear;
                })
                .reduce((total, gasto) => total + (gasto.monto || 0), 0);

            const utilidad = margenMes - gastosMes;

            // Calcular ingresos por medio de pago
            const ingresosPorMedioPago = calculateIngresosPorMedioPago(currentMonth, currentYear);

            document.getElementById('resumenFinanciero').innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <div>Ingresos Trabajos: ${formatCurrency(ingresosTrabajo)}</div>
                    <div>Ingresos Venta Insumos: ${formatCurrency(ingresosVentaInsumos)}</div>
                    <div style="border-top: 1px solid var(--border-color); padding-top: 0.5rem;">
                        <div style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleIngresosMedioPago()">
                            <strong>Ingresos Totales:</strong> 
                            <div>
                                <span>${formatCurrency(ingresosMes)}</span>
                                <i id="ingresosMedioPagoIcon" class="fas fa-chevron-down" style="margin-left: 10px; font-size: 0.8em; color: var(--primary-color);"></i>
                            </div>
                        </div>
                        <div id="ingresosMedioPagoDetails" style="display: none; margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid var(--primary-color);">
                            ${generateIngresosMedioPagoHtml(ingresosPorMedioPago, ingresosMes)}
                        </div>
                    </div>
                    <div style="border-top: 1px solid var(--border-color); padding-top: 0.5rem;">Ganancia Trabajos: ${formatCurrency(margenTrabajo)}</div>
                    <div>Ganancia Venta Insumos: ${formatCurrency(margenVentaInsumos)}</div>
                    <div><strong>Ganancia Bruta:</strong> ${formatCurrency(margenMes)}</div>
                    <div style="border-top: 1px solid var(--border-color); padding-top: 0.5rem;"><strong>Gastos Totales:</strong> ${formatCurrency(gastosMes)}</div>
                    <div style="border-top: 1px solid var(--border-color); padding-top: 0.5rem;"><strong>Ganancia Neta:</strong> <span style="color: ${utilidad >= 0 ? 'var(--success-color)' : 'var(--error-color)'}">${formatCurrency(utilidad)}</span></div>
                </div>
            `;
        }

        function calculateIngresosPorMedioPago(currentMonth, currentYear) {
            const mediosPago = {
                'Efectivo': 0,
                'MercadoPago': 0,
                'Otro': 0
            };

            // Sumar ingresos de facturas por medio de pago
            appData.facturas
                .filter(factura => {
                    const fecha = new Date(factura.fecha);
                    return fecha.getMonth() === currentMonth && fecha.getFullYear() === currentYear;
                })
                .forEach(factura => {
                    const medioPago = factura.medioPago || 'Otro';
                    mediosPago[medioPago] = (mediosPago[medioPago] || 0) + parseFloat(factura.total || 0);
                });

            // Sumar ingresos de ventas de insumos por método de pago
            appData.ventasInsumos
                .filter(venta => {
                    const fecha = new Date(venta.fecha);
                    return fecha.getMonth() === currentMonth && fecha.getFullYear() === currentYear;
                })
                .forEach(venta => {
                    const metodoPago = venta.metodoPago || 'Otro';
                    // Normalizar nombres de métodos de pago
                    let medioPago = metodoPago === 'Efectivo' ? 'Efectivo' : 
                                   metodoPago === 'MercadoPago' ? 'MercadoPago' : 'Otro';
                    mediosPago[medioPago] = (mediosPago[medioPago] || 0) + parseFloat(venta.total || 0);
                });

            return mediosPago;
        }

        function generateIngresosMedioPagoHtml(ingresosPorMedioPago, ingresosTotales) {
            let html = '<div style="display: grid; gap: 8px;">';
            
            Object.entries(ingresosPorMedioPago).forEach(([medioPago, monto]) => {
                const porcentaje = ingresosTotales > 0 ? ((monto / ingresosTotales) * 100).toFixed(1) : 0;
                const colorBarra = medioPago === 'Efectivo' ? '#27ae60' : 
                                  medioPago === 'MercadoPago' ? '#3498db' : '#95a5a6';
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 12px; height: 12px; background: ${colorBarra}; border-radius: 2px;"></div>
                            <span style="font-weight: 500;">${medioPago}:</span>
                        </div>
                        <div style="text-align: right;">
                            <div>${formatCurrency(monto)}</div>
                            <div style="font-size: 0.85em; color: #666;">${porcentaje}%</div>
                        </div>
                    </div>
                    <div style="background: #e9ecef; border-radius: 10px; height: 6px; margin-bottom: 8px;">
                        <div style="background: ${colorBarra}; height: 100%; border-radius: 10px; width: ${porcentaje}%; transition: width 0.3s ease;"></div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function toggleIngresosMedioPago() {
            const details = document.getElementById('ingresosMedioPagoDetails');
            const icon = document.getElementById('ingresosMedioPagoIcon');
            
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                details.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        function generateTopClientes() {
            const clienteStats = {};
            
            appData.trabajos.forEach(trabajo => {
                if (!clienteStats[trabajo.cliente]) {
                    clienteStats[trabajo.cliente] = { total: 0, count: 0 };
                }
                clienteStats[trabajo.cliente].total += trabajo.total || 0;
                clienteStats[trabajo.cliente].count += 1;
            });
            
            const topClientes = Object.entries(clienteStats)
                .sort(([,a], [,b]) => b.total - a.total)
                .slice(0, 5);
                
            let html = '<div style="display: grid; gap: 0.5rem;">';
            topClientes.forEach(([cliente, stats]) => {
                html += `<div style="display: flex; justify-content: space-between;"><span>${cliente}</span><span>${formatCurrency(stats.total)} (${stats.count} trabajos)</span></div>`;
            });
            html += '</div>';
            
            document.getElementById('topClientes').innerHTML = html;
        }

        function generateGastosPorCategoria() {
            const gastosPorCategoria = {};
            let totalGastos = 0;
            
            // Filtrar gastos por mes y año seleccionados
            const selectedDate = getSelectedMonthYear();
            appData.gastos.forEach(gasto => {
                const fecha = new Date(gasto.fecha);
                if (fecha.getMonth() === selectedDate.month && fecha.getFullYear() === selectedDate.year) {
                    const categoria = gasto.categoria || 'Sin categoría';
                    if (!gastosPorCategoria[categoria]) {
                        gastosPorCategoria[categoria] = 0;
                    }
                    gastosPorCategoria[categoria] += gasto.monto || 0;
                    totalGastos += gasto.monto || 0;
                }
            });
            
            let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
            
            if (totalGastos === 0) {
                html += '<p>No hay gastos registrados</p>';
            } else {
                // Sort categories by amount
                const sortedCategories = Object.entries(gastosPorCategoria)
                    .sort(([,a], [,b]) => b - a);
                
                sortedCategories.forEach(([categoria, monto]) => {
                    const porcentaje = ((monto / totalGastos) * 100).toFixed(1);
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #eee;">
                            <span style="font-weight: 500;">${categoria}</span>
                            <div style="text-align: right;">
                                <div style="font-weight: bold;">${formatCurrency(monto)}</div>
                                <div style="font-size: 0.8em; color: #666;">${porcentaje}%</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            document.getElementById('gastosChart').innerHTML = html;
        }

        function generateEvolucionMensual() {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth();
            
            const monthlyData = [];
            
            // Generate last 12 months starting from current month
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentYear, currentMonth - i, 1);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData.push({
                    key: monthKey,
                    year: date.getFullYear(),
                    month: date.getMonth(),
                    monthName: date.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' }),
                    ingresos: 0,
                    margen: 0,
                    gastos: 0
                });
            }
            
            // Calculate monthly income and margin from trabajos
            appData.trabajos.forEach(trabajo => {
                const fecha = new Date(trabajo.fechaIngreso || trabajo.fecha);
                const monthData = monthlyData.find(m => 
                    m.year === fecha.getFullYear() && m.month === fecha.getMonth()
                );
                if (monthData) {
                    monthData.ingresos += trabajo.total || 0;
                    if (typeof trabajo.margen === 'number') {
                        monthData.margen += trabajo.margen;
                    } else {
                        monthData.margen += trabajo.total || 0;
                    }
                }
            });
            
            // Calculate monthly income and margin from ventas de insumos
            appData.ventasInsumos.forEach(venta => {
                const fecha = new Date(venta.fecha);
                const monthData = monthlyData.find(m => 
                    m.year === fecha.getFullYear() && m.month === fecha.getMonth()
                );
                if (monthData) {
                    monthData.ingresos += parseFloat(venta.total || 0);
                    monthData.margen += parseFloat(venta.margen || 0);
                }
            });
            
            // Calculate monthly expenses from gastos
            appData.gastos.forEach(gasto => {
                const fecha = new Date(gasto.fecha);
                const monthData = monthlyData.find(m => 
                    m.year === fecha.getFullYear() && m.month === fecha.getMonth()
                );
                if (monthData) {
                    monthData.gastos += gasto.monto || 0;
                }
            });
            
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 0.9em;"><thead><tr>';
            html += '<th style="padding: 0.5rem; text-align: left;">Mes</th>';
            html += '<th style="padding: 0.5rem; text-align: right;">Ingreso</th>';
            html += '<th style="padding: 0.5rem; text-align: right;">Margen</th>';
            html += '<th style="padding: 0.5rem; text-align: right;">Gastos</th>';
            html += '<th style="padding: 0.5rem; text-align: right;">Ganancia</th>';
            html += '</tr></thead><tbody>';
            
            monthlyData.forEach((data, index) => {
                const gananciaNeta = data.margen - data.gastos;
                const gananciaClass = gananciaNeta >= 0 ? 'color: #27ae60;' : 'color: #e74c3c;';
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 0.5rem;">${data.monthName}</td>
                        <td style="padding: 0.5rem; text-align: right;">${formatCurrency(data.ingresos)}</td>
                        <td style="padding: 0.5rem; text-align: right;">${formatCurrency(data.margen)}</td>
                        <td style="padding: 0.5rem; text-align: right;">${formatCurrency(data.gastos)}</td>
                        <td style="padding: 0.5rem; text-align: right; ${gananciaClass} font-weight: bold;">${formatCurrency(gananciaNeta)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('evolucionChart').innerHTML = html;
            
            // Agregar icono de tendencia para evolución mensual
            updateTrendIcon('evolucionMensualTrend', monthlyData);
        }

        function generateEvolucionSemanal() {
            const now = new Date();
            const weeklyData = [];
            
            // Generate last 4 weeks starting from current week
            for (let i = 0; i < 4; i++) {
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - (i * 7) - now.getDay()); // Start of week (Sunday)
                weekStart.setHours(0, 0, 0, 0);
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6); // End of week (Saturday)
                weekEnd.setHours(23, 59, 59, 999);
                
                weeklyData.push({ 
                    ingresos: 0, 
                    margen: 0, 
                    gastos: 0, 
                    weekStart: weekStart, 
                    weekEnd: weekEnd 
                });
            }
            
            // Calculate weekly income and margin from trabajos
            appData.trabajos.forEach(trabajo => {
                const fecha = new Date(trabajo.fechaIngreso || trabajo.fecha);
                
                weeklyData.forEach(data => {
                    if (fecha >= data.weekStart && fecha <= data.weekEnd) {
                        data.ingresos += trabajo.total || 0;
                        if (typeof trabajo.margen === 'number') {
                            data.margen += trabajo.margen;
                        } else {
                            data.margen += trabajo.total || 0;
                        }
                    }
                });
            });
            
            // Calculate weekly income and margin from ventas de insumos
            appData.ventasInsumos.forEach(venta => {
                const fecha = new Date(venta.fecha);
                
                weeklyData.forEach(data => {
                    if (fecha >= data.weekStart && fecha <= data.weekEnd) {
                        data.ingresos += parseFloat(venta.total || 0);
                        data.margen += parseFloat(venta.margen || 0);
                    }
                });
            });
            
            // Calculate weekly expenses from gastos
            appData.gastos.forEach(gasto => {
                const fecha = new Date(gasto.fecha);
                
                weeklyData.forEach(data => {
                    if (fecha >= data.weekStart && fecha <= data.weekEnd) {
                        data.gastos += gasto.monto || 0;
                    }
                });
            });
            
            let html = '<div style="overflow-x: auto;"><table style="width: 100%; font-size: 0.9em;"><thead><tr>';
            html += '<th style="padding: 0.5rem; text-align: left;">Semana</th>';
            html += '<th style="padding: 0.5rem; text-align: right;">Ingreso</th>';
            html += '<th style="padding: 0.5rem; text-align: right;">Margen</th>';
            html += '<th style="padding: 0.5rem; text-align: right;">Gastos</th>';
            html += '<th style="padding: 0.5rem; text-align: right;">Ganancia</th>';
            html += '</tr></thead><tbody>';
            
            weeklyData.forEach((data, index) => {
                const gananciaNeta = data.margen - data.gastos;
                const gananciaClass = gananciaNeta >= 0 ? 'color: #27ae60;' : 'color: #e74c3c;';
                
                const weekLabel = `${String(data.weekStart.getDate()).padStart(2, '0')}/${String(data.weekStart.getMonth() + 1).padStart(2, '0')} - ${String(data.weekEnd.getDate()).padStart(2, '0')}/${String(data.weekEnd.getMonth() + 1).padStart(2, '0')}`;
                
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 0.5rem;">${weekLabel}</td>
                        <td style="padding: 0.5rem; text-align: right;">${formatCurrency(data.ingresos)}</td>
                        <td style="padding: 0.5rem; text-align: right;">${formatCurrency(data.margen)}</td>
                        <td style="padding: 0.5rem; text-align: right;">${formatCurrency(data.gastos)}</td>
                        <td style="padding: 0.5rem; text-align: right; ${gananciaClass} font-weight: bold;">${formatCurrency(gananciaNeta)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('evolucionSemanalChart').innerHTML = html;
            
            // Agregar icono de tendencia para evolución semanal
            updateTrendIcon('evolucionSemanalTrend', weeklyData);
        }

        function updateTrendIcon(elementId, data) {
            // Si data es un array, usarlo directamente; si es un objeto, convertir a array
            const dataArray = Array.isArray(data) ? data : Object.values(data);
            if (dataArray.length < 2) {
                document.getElementById(elementId).innerHTML = '';
                return;
            }
            
            const current = dataArray[0]; // Primer elemento (más reciente)
            const previous = dataArray[1]; // Segundo elemento (anterior)
            
            const currentGanancia = current.margen - current.gastos;
            const previousGanancia = previous.margen - previous.gastos;
            
            let icon = '';
            let color = '';
            
            if (currentGanancia > previousGanancia) {
                icon = '<i class="fas fa-arrow-up"></i>';
                color = '#27ae60';
            } else if (currentGanancia < previousGanancia) {
                icon = '<i class="fas fa-arrow-down"></i>';
                color = '#e74c3c';
            } else {
                icon = '<i class="fas fa-minus"></i>';
                color = '#f39c12';
            }
            
            document.getElementById(elementId).innerHTML = `<span style="color: ${color};">${icon}</span>`;
        }
        
        // Presupuestos functionality
        function showPresupuestoModal() {
            document.getElementById('presupuestoModal').classList.add('show');
            clearPresupuestoForm();
            loadClientesForAutocomplete();
            loadVehiculosDatalist('vehiculosPresupuestoList');
        }

        function hidePresupuestoModal() {
            document.getElementById('presupuestoModal').classList.remove('show');
        }

        function clearPresupuestoForm() {
            document.getElementById('presupuestoForm').reset();
            document.getElementById('repuestosContainer').innerHTML = '';
            document.getElementById('manoObraContainer').innerHTML = '';
            document.querySelector('#presupuestoModal .modal-title').textContent = 'Nuevo Presupuesto';
            delete document.getElementById('presupuestoForm').dataset.editingId;
            updatePresupuestoTotals();
            loadClientesForAutocomplete();
        }

        function loadClientesForAutocomplete() {
            const datalist = document.getElementById('clientesList');
            datalist.innerHTML = '';
            
            // Get unique clients from presupuestos and trabajos
            const clientesSet = new Set();
            
            // Add clients from presupuestos
            appData.presupuestos.forEach(p => {
                let clienteNombre = '';
                let clienteTelefono = '';
                
                // Handle different client data structures
                if (typeof p.cliente === 'string') {
                    clienteNombre = p.cliente;
                    clienteTelefono = p.telefono || '';
                } else if (p.cliente && p.cliente.nombre) {
                    clienteNombre = p.cliente.nombre;
                    clienteTelefono = p.cliente.telefono || p.telefono || '';
                }
                
                if (clienteNombre && clienteNombre.trim()) {
                    clientesSet.add(JSON.stringify({
                        nombre: clienteNombre,
                        telefono: clienteTelefono
                    }));
                }
            });
            
            // Add clients from trabajos
            appData.trabajos.forEach(t => {
                if (t.cliente && t.cliente.trim()) {
                    clientesSet.add(JSON.stringify({
                        nombre: t.cliente,
                        telefono: t.telefono || ''
                    }));
                }
            });
            
            // Create options for datalist
            Array.from(clientesSet).forEach(clienteStr => {
                const cliente = JSON.parse(clienteStr);
                const option = document.createElement('option');
                option.value = cliente.nombre;
                option.setAttribute('data-telefono', cliente.telefono);
                datalist.appendChild(option);
            });
        }

        function handleClienteInput() {
            // This function is called on every keystroke
            // We can use it for real-time filtering if needed
        }

        function handleClienteChange() {
            const clienteInput = document.getElementById('clienteNombre');
            const telefonoInput = document.getElementById('clienteTelefono');
            const datalist = document.getElementById('clientesList');
            
            // Find the selected option
            const selectedOption = Array.from(datalist.options).find(option => 
                option.value === clienteInput.value
            );
            
            if (selectedOption) {
                // Auto-fill telefono if option was selected
                const telefono = selectedOption.getAttribute('data-telefono');
                if (telefono && telefono.trim()) {
                    telefonoInput.value = telefono;
                }
            }
        }

        function addRepuesto() {
            const container = document.getElementById('repuestosContainer');
            const index = container.children.length;
            
            const row = document.createElement('div');
            row.className = 'form-grid-2';
            row.style.border = '1px solid var(--border-color)';
            row.style.padding = '1rem';
            row.style.borderRadius = '0.5rem';
            row.style.marginBottom = '1rem';
            
            row.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <input type="text" class="form-input repuesto-desc" required oninput="formatTitleCase(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">Cantidad</label>
                    <input type="number" class="form-input repuesto-cant" min="0.01" step="0.01" value="1" onchange="updatePresupuestoTotals()" oninput="updatePresupuestoTotals()">
                </div>
                <div class="form-group">
                    <label class="form-label">Precio Unitario</label>
                    <input type="number" class="form-input repuesto-precio" min="0" step="1" onchange="updatePresupuestoTotals()" oninput="updatePresupuestoTotals()">
                </div>
                <div class="form-group">
                    <label class="form-label">Subtotal</label>
                    <input type="text" class="form-input repuesto-subtotal" readonly>
                </div>
                <div class="form-group" style="display: flex; align-items: end; grid-column: span 2;">
                    <button type="button" class="btn btn-danger" onclick="this.parentElement.parentElement.remove(); updatePresupuestoTotals();">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(row);
            updatePresupuestoTotals(); // Trigger calculation after adding
        }

        function addManoObra() {
            const container = document.getElementById('manoObraContainer');
            
            const row = document.createElement('div');
            row.className = 'form-grid-2';
            row.style.border = '1px solid var(--border-color)';
            row.style.padding = '1rem';
            row.style.borderRadius = '0.5rem';
            row.style.marginBottom = '1rem';
            
            row.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <input type="text" class="form-input trabajo-desc" required oninput="formatTitleCase(this)">
                </div>
                <div class="form-group">
                    <label class="form-label">Valor</label>
                    <input type="number" class="form-input trabajo-valor" min="0" step="1" onchange="updatePresupuestoTotals()" oninput="updatePresupuestoTotals()">
                </div>
                <div class="form-group" style="display: flex; align-items: end; grid-column: span 2;">
                    <button type="button" class="btn btn-danger" onclick="this.parentElement.parentElement.remove(); updatePresupuestoTotals();">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(row);
            updatePresupuestoTotals(); // Trigger calculation after adding
        }

        function updatePresupuestoTotals() {
            let subtotal = 0;

            // Calculate repuestos

            const repuestosContainer = document.getElementById('repuestosContainer');
            if (repuestosContainer) {
                repuestosContainer.querySelectorAll('.form-grid, .form-grid-2').forEach(row => {
                    const cantInput = row.querySelector('.repuesto-cant');
                    const precioInput = row.querySelector('.repuesto-precio');
                    const subtotalInput = row.querySelector('.repuesto-subtotal');
                    const cantidad = parseFloat(cantInput?.value || 0);
                    const precio = parseFloat(precioInput?.value || 0);
                    const subtotalRepuesto = cantidad * precio;
                    if (subtotalInput) {
                        subtotalInput.value = formatCurrency(subtotalRepuesto);
                    }
                    subtotal += subtotalRepuesto;
                });
            }

            // Calculate mano de obra
            const manoObraContainer = document.getElementById('manoObraContainer');
            if (manoObraContainer) {
                manoObraContainer.querySelectorAll('.form-grid, .form-grid-2').forEach(row => {
                    const valorInput = row.querySelector('.trabajo-valor');
                    const valor = parseFloat(valorInput?.value || 0);
                    subtotal += valor;
                });
            }

            const total = subtotal; // Direct total without IVA

            const totalElement = document.getElementById('totalPresupuesto');
            if (totalElement) {
                totalElement.textContent = formatCurrency(total);
            }
        }

        async function handlePresupuestoSubmit(e) {
            e.preventDefault();
            
            const editingId = e.target.dataset.editingId;
            
            // Collect form data
            const presupuestoData = {
                cliente: {
                    nombre: document.getElementById('clienteNombre').value,
                    telefono: document.getElementById('clienteTelefono').value
                },
                vehiculo: document.getElementById('vehiculo').value,
                placa: document.getElementById('placa').value,
                diagnostico: document.getElementById('presupuestoDiagnostico').value,
                repuestos: collectRepuestos(),
                manoObra: collectManoObra(),
                subtotal: calculateSubtotal(),
                total: calculateTotal()
            };

            // Guardar vehículo en caché
            saveVehiculoToCache(presupuestoData.vehiculo);

            if (editingId) {
                // Update existing presupuesto
                const index = appData.presupuestos.findIndex(p => p.id === editingId);
                if (index !== -1) {
                    appData.presupuestos[index] = { 
                        ...appData.presupuestos[index], 
                        ...presupuestoData,
                        fechaModificacion: new Date().toISOString().split('T')[0]
                    };
                    
                    // Update in Firebase
                    await updateInFirebase('presupuestos', appData.presupuestos[index]);
                    
                    showToast('Presupuesto actualizado correctamente', 'success');
                }
                delete e.target.dataset.editingId;
            } else {
                // Create new presupuesto
                const presupuesto = {
                    id: Date.now().toString(),
                    numero: getNextPresupuestoNumber(),
                    estado: 'Pendiente',
                    fecha: new Date().toISOString().split('T')[0],
                    ...presupuestoData
                };
                
                appData.presupuestos.push(presupuesto);
                
                // Save to Firebase
                await saveToFirebase('presupuestos', presupuesto);
                
                showToast('Presupuesto guardado correctamente', 'success');
            }
            
            hidePresupuestoModal();
            loadPresupuestos();
        }

        function collectRepuestos() {
            const repuestos = [];
            document.querySelectorAll('#repuestosContainer .form-grid, #repuestosContainer .form-grid-2').forEach(row => {
                const desc = row.querySelector('.repuesto-desc').value;
                const cant = parseFloat(row.querySelector('.repuesto-cant').value) || 0;
                const precio = parseFloat(row.querySelector('.repuesto-precio').value) || 0;
                if (desc && cant && precio) {
                    repuestos.push({
                        descripcion: desc,
                        cantidad: cant,
                        precio: precio,
                        subtotal: cant * precio
                    });
                }
            });
            return repuestos;
        }

        function collectManoObra() {
            const trabajos = [];
            document.querySelectorAll('#manoObraContainer .form-grid, #manoObraContainer .form-grid-2').forEach(row => {
                const desc = row.querySelector('.trabajo-desc').value;
                const valor = parseFloat(row.querySelector('.trabajo-valor').value) || 0;
                if (desc && valor) {
                    trabajos.push({
                        descripcion: desc,
                        valor: valor
                    });
                }
            });
            return trabajos;
        }

        function calculateSubtotal() {
            let subtotal = 0;
            
            // Calcular repuestos
            const repuestosContainer = document.getElementById('repuestosContainer');
            if (repuestosContainer) {
                repuestosContainer.querySelectorAll('.form-grid, .form-grid-2').forEach(row => {
                    const cantInput = row.querySelector('.repuesto-cant, input[placeholder*="Cantidad"]');
                    const precioInput = row.querySelector('.repuesto-precio, input[placeholder*="Precio"]');
                    const cantidad = parseFloat(cantInput?.value || 0);
                    const precio = parseFloat(precioInput?.value || 0);
                    subtotal += cantidad * precio;
                });
            }

            // Calcular mano de obra
            const manoObraContainer = document.getElementById('manoObraContainer');
            if (manoObraContainer) {
                manoObraContainer.querySelectorAll('.form-grid, .form-grid-2').forEach(row => {
                    const valorInput = row.querySelector('.trabajo-valor, input[placeholder*="Valor"]');
                    const valor = parseFloat(valorInput?.value || 0);
                    subtotal += valor;
                });
            }

            return subtotal;
        }

        function calculateTotal() {
            return calculateSubtotal(); // No IVA calculation
        }

        function getNextPresupuestoNumber() {
            const lastNumber = appData.presupuestos.reduce((max, p) => {
                const num = parseInt(p.numero) || 0;
                return num > max ? num : max;
            }, 0);
            return (lastNumber + 1).toString().padStart(4, '0');
        }

        function loadPresupuestos() {
            const tbody = document.getElementById('presupuestosTable');
            tbody.innerHTML = '';

            appData.presupuestos.forEach(presupuesto => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${presupuesto.numero}</td>
                    <td>${presupuesto.cliente.nombre}</td>
                    <td>${presupuesto.vehiculo}</td>
                    <td>${formatCurrency(presupuesto.total)}</td>
                    <td><span class="badge badge-${getStatusClass(presupuesto.estado)}">${presupuesto.estado}</span></td>
                    <td>${formatDate(presupuesto.fecha)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewPresupuesto('${presupuesto.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="printPresupuesto('${presupuesto.id}')" title="Imprimir presupuesto">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="editPresupuesto('${presupuesto.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletePresupuesto('${presupuesto.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        function updateDashboard() {
            // Calculate metrics
            const ingresosMes = calculateIngresosMes();
            const trabajosActivos = appData.trabajos.filter(t => t.estado === 'En Proceso').length;
            const presupuestosPendientes = appData.presupuestos.filter(p => p.estado === 'Pendiente').length;
            const margenPromedio = calculateMargenPromedio();
            const facturasPendientes = appData.facturas.filter(f => f.estadoPago === 'Pendiente').length;

            // Update dashboard cards
            const trabajosActivosEl = document.getElementById('trabajosActivos');
            if (trabajosActivosEl) trabajosActivosEl.textContent = trabajosActivos;
            const presupuestosPendientesEl = document.getElementById('presupuestosPendientes');
            if (presupuestosPendientesEl) presupuestosPendientesEl.textContent = presupuestosPendientes;
            const facturasPendientesEl = document.getElementById('facturasPendientes');
            if (facturasPendientesEl) facturasPendientesEl.textContent = facturasPendientes;

            // Load recent work
            loadTrabajosRecientes();
        }

        function calculateVentasInsumosMes() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            return appData.ventasInsumos
                .filter(venta => {
                    const ventaDate = new Date(venta.fecha);
                    return ventaDate.getMonth() === currentMonth && ventaDate.getFullYear() === currentYear;
                })
                .reduce((total, venta) => total + parseFloat(venta.total || 0), 0);
        }

        function calculateIngresosMes() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const ingresosTrabajo = appData.trabajos
                .filter(trabajo => {
                    const fecha = new Date(trabajo.fecha);
                    return fecha.getMonth() === currentMonth && fecha.getFullYear() === currentYear;
                })
                .reduce((total, trabajo) => total + (trabajo.total || 0), 0);
                
            const ingresosVentaInsumos = appData.ventasInsumos
                .filter(venta => {
                    const fecha = new Date(venta.fecha);
                    return fecha.getMonth() === currentMonth && fecha.getFullYear() === currentYear;
                })
                .reduce((total, venta) => total + parseFloat(venta.total || 0), 0);
                
            return ingresosTrabajo + ingresosVentaInsumos;
        }

        function calculateMargenPromedio() {
            const totalTrabajos = appData.trabajos.length;
            const totalVentasInsumos = appData.ventasInsumos.length;
            
            if (totalTrabajos === 0 && totalVentasInsumos === 0) return 0;
            
            const margenTrabajos = appData.trabajos.reduce((total, trabajo) => {
                return total + (trabajo.margen || 0);
            }, 0);
            
            const margenVentasInsumos = appData.ventasInsumos.reduce((total, venta) => {
                return total + (venta.margen || 0);
            }, 0);
            
            const totalItems = totalTrabajos + totalVentasInsumos;
            return Math.round((margenTrabajos + margenVentasInsumos) / totalItems);
        }

        function loadTrabajosRecientes() {
            const tbody = document.getElementById('trabajosRecientes');
            tbody.innerHTML = '';

            const recentWork = appData.trabajos
                .filter(t => t.estado === 'En Proceso')
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
                .slice(0, 5);

            if (recentWork.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay trabajos registrados</td></tr>';
                return;
            }

            recentWork.forEach(trabajo => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${trabajo.cliente}</td>
                    <td>${trabajo.vehiculo}</td>
                    <td><span class="badge badge-${getStatusClass(trabajo.estado)}">${trabajo.estado}</span></td>
                    <td>${formatCurrency(trabajo.total)}</td>
                    <td>${formatDate(trabajo.fecha)}</td>
                `;
            });
        }

        // Utility functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(amount || 0);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('es-CO');
        }

        // Funciones de caché para vehículos
        function getVehiculosCache() {
            const cache = localStorage.getItem('vehiculos_cache');
            return cache ? JSON.parse(cache) : [];
        }

        function saveVehiculoToCache(vehiculo) {
            if (!vehiculo || vehiculo.trim() === '') return;
            
            const vehiculos = getVehiculosCache();
            const vehiculoNormalizado = vehiculo.trim().toUpperCase();
            
            // Evitar duplicados
            if (!vehiculos.some(v => v.toUpperCase() === vehiculoNormalizado)) {
                vehiculos.push(vehiculo.trim());
                // Mantener solo los últimos 50 vehículos
                if (vehiculos.length > 50) {
                    vehiculos.splice(0, vehiculos.length - 50);
                }
                localStorage.setItem('vehiculos_cache', JSON.stringify(vehiculos));
            }
        }

        function loadVehiculosDatalist(datalistId) {
            const datalist = document.getElementById(datalistId);
            if (!datalist) return;
            
            const vehiculos = getVehiculosCache();
            datalist.innerHTML = '';
            
            vehiculos.forEach(vehiculo => {
                const option = document.createElement('option');
                option.value = vehiculo;
                datalist.appendChild(option);
            });
        }

        function populateVehiculosCache() {
            // Extraer vehículos de presupuestos existentes
            appData.presupuestos.forEach(presupuesto => {
                if (presupuesto.vehiculo) {
                    saveVehiculoToCache(presupuesto.vehiculo);
                }
            });
            
            // Extraer vehículos de trabajos existentes
            appData.trabajos.forEach(trabajo => {
                if (trabajo.vehiculo) {
                    saveVehiculoToCache(trabajo.vehiculo);
                }
            });
        }

        // Funciones de formateo automático
        function formatPlaca(input) {
            // Solo letras y números, letras en mayúscula
            let value = input.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
            input.value = value;
        }

        function formatTelefono(input) {
            // Solo números
            let value = input.value.replace(/[^0-9]/g, '');
            input.value = value;
        }

        function formatTitleCase(input) {
            // Primera letra de cada palabra en mayúscula, resto en minúscula
            let value = input.value.toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
            input.value = value;
        }

        function getStatusClass(status) {
            const classes = {
                'Pendiente': 'warning',
                'Aprobado': 'success',
                'Rechazado': 'danger',
                'En Proceso': 'primary',
                'Completado': 'success',
                'Entregado': 'info',
                'Cobrado': 'success'
            };
            return classes[status] || 'secondary';
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">×</button>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Add missing CSS for badges
        const additionalStyles = `
            .badge {
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                font-size: 0.75rem;
                font-weight: 500;
                text-transform: uppercase;
            }
            .badge-primary { background: var(--primary-color); color: white; }
            .badge-success { background: var(--success-color); color: white; }
            .badge-warning { background: var(--warning-color); color: white; }
            .badge-danger { background: var(--error-color); color: white; }
            .badge-info { background: #0ea5e9; color: white; }
            .badge-secondary { background: var(--secondary-color); color: white; }
            
            .btn-sm {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalStyles;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>